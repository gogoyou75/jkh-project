<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="critical_guard.js" defer></script>
    <title>Квартиры / адреса</title>

    <link rel="stylesheet" href="style.css">

    <!-- данные и лэйаут -->
    <script src="data.js"></script>
    <script src="layout.js"></script>
    <script src="premises_admin.js"></script>

    <style>
        .panel {
            border: 2px solid #000;
            padding: 12px;
            margin: 10px 0 16px;
            background: #fff;
        }
        .panel h3 {
            margin: 0 0 10px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: 220px 1fr 220px 1fr;
            gap: 8px 12px;
            align-items: center;
        }
        .grid label {
            font-size: 13px;
            text-align: right;
            padding-right: 6px;
        }
        .grid input {
            height: 26px;
            border: 1px solid #000;
            padding: 3px 6px;
            box-sizing: border-box;
            font-size: 13px;
            width: 100%;
        }
        .actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            border: 2px solid #000;
            padding: 8px 12px;
            background: #e5e5e5;
            cursor: pointer;
            font-size: 14px;
        }
        .hint {
            font-size: 12px;
            color: #333;
            margin-top: 8px;
            line-height: 1.35;
        }
        .warn {
            border: 2px solid #000;
            padding: 8px 10px;
            margin: 8px 0 0;
            background: #fff6e5;
            font-size: 13px;
            display: none;
        }
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin: 0 0 10px;
        }
        .filters input {
            height: 26px;
            border: 1px solid #000;
            padding: 3px 6px;
            font-size: 13px;
        }
        .small {
            font-size: 12px;
        }
        .row-actions button {
            border: 2px solid #000;
            background: #fff;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 12px;
        }
        .row-actions button:hover {
            background: #f2f2f2;
        }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

        /* подсказки дублей (похожие адреса) */
        .dups {
            border: 2px solid #000;
            padding: 8px 10px;
            margin-top: 10px;
            background: #fff;
            display: none;
            font-size: 13px;
        }
        .dups .title { font-weight: bold; margin-bottom: 6px; }
        .dups table { width: 100%; border-collapse: collapse; margin-top: 6px; }
        .dups th, .dups td { border: 1px solid #000; padding: 4px 6px; font-size: 12px; vertical-align: top; }
        .dups .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .hit { background: #ffe0e0; padding: 0 2px; }
        .near { background: #fff3bf; padding: 0 2px; }
    </style>
</head>
<body>

<script>renderLayout();</script>

<div class="content">
    <h2>КВАРТИРЫ / АДРЕСА</h2>

    <div class="panel">
        <h3 id="premFormTitle">Добавить квартиру (объект)</h3>

        <!-- ✅ datalist для автоподсказок -->
        <datalist id="cityList"></datalist>
        <datalist id="streetList"></datalist>

        <div class="grid">
            <label for="p_regnum">Регистрационный № квартиры (regnum)</label>
            <div>
                <input id="p_regnum" class="mono" placeholder="например: 01:04:1201004:185" style="width:100%;">
                <div class="small" style="margin-top:4px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <label style="text-align:left; padding-right:0; display:flex; gap:6px; align-items:center;">
                        <input id="p_regnum_unknown" type="checkbox" style="height:auto; width:auto;">
                        regnum неизвестен (создать временный)
                    </label>
                    <span id="p_regnum_hint" class="small"></span>
                </div>
            </div>

            <label for="p_created">Дата создания записи объекта</label>
            <input id="p_created" type="date">

            <label for="p_city">Город</label>
            <!-- ✅ подключили list -->
            <input id="p_city" list="cityList" placeholder="например: г. Магадан">

            <label for="p_square">Площадь, м²</label>
            <input id="p_square" type="number" step="0.01" placeholder="например: 29.9">

            <label for="p_street">Улица</label>
            <!-- ✅ подключили list -->
            <input id="p_street" list="streetList" placeholder="например: ул Карла Маркса">

            <label for="p_house">Дом</label>
            <input id="p_house" placeholder="например: дом 50">

            <label for="p_flat">Квартира (номер)</label>
            <input id="p_flat" placeholder="например: квартира 27">

            <label></label>
            <div class="small">regnum — уникальный и не должен меняться.</div>
        </div>

        <div class="actions">
            <button class="btn" id="btnPremSave">Сохранить</button>
            <button class="btn" id="btnPremReset" type="button">Очистить</button>
            <button class="btn" id="btnCreateAbonentFromPremise" type="button" style="display:none;">Создать абонента на эту квартиру</button>
        </div>

        <div id="premDupBox" class="dups">
            <div class="title">Похожие адреса (контроль дублей)</div>
            <div id="premDupBody"></div>
        </div>

        <div id="premFormWarn" class="warn"></div>

        <div class="hint">
            <b>Важно:</b> если по квартире уже есть связи с абонентами (история собственников/проживающих),
            мы не дадим удалить объект, чтобы не сломать историю. Адрес можно редактировать.
        </div>
    </div>

    <div class="panel">
        <h3>Список квартир</h3>
        <div class="filters">
            <input id="premSearch" placeholder="поиск: regnum / город / улица / дом / кв" style="min-width: 360px;">
            <span class="small" id="premCount"></span>
        </div>

        <table id="premisesTable">
            <thead>
                <tr>
                    <th style="width: 200px;">regnum</th>
                    <th>город</th>
                    <th>улица</th>
                    <th style="width: 120px;">дом</th>
                    <th style="width: 140px;">кв</th>
                    <th style="width: 90px;">площадь</th>
                    <th style="width: 120px;">создана</th>
                    <th style="width: 160px;">действующий ответственный</th>
                    <th style="width: 140px;">действие</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        PremisesAdmin.init();
    });
</script>

</body>
</html>
