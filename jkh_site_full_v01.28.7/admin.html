<!DOCTYPE html>
<!-- ============================================================
üîí CRITICAL ‚Äî ADMIN PANEL | Date: 2026-01-27
- –¢—Ä–µ–±—É–µ—Ç –≤—Ö–æ–¥ (Auth)
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ admin
- –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –±–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞ (–æ–¥–∏–Ω JSON)
============================================================ -->
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <script src="critical_guard.js" defer></script>
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="style.css">

    <script src="auth.js" defer></script>
    <script src="layout.js"></script>

    <style>
        .panel {
            border: 2px solid #000;
            padding: 12px;
            margin: 12px 0;
            background: #fff;
            max-width: 980px;
        }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .row > * { margin: 2px 0; }
        label { font-size: 13px; }
        input[type="text"], input[type="password"], select {
            height: 28px;
            padding: 3px 6px;
            border: 1px solid #000;
            font-size: 13px;
        }
        button {
            border: 1px solid #000;
            background: #fff;
            height: 28px;
            padding: 0 10px;
            cursor: pointer;
            font-size: 13px;
        }
        button:hover { background: #f2f2f2; }
        .hint { font-size: 12px; color: #333; }
        .danger { color: #b00000; font-weight: bold; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #000; padding: 6px 6px; font-size: 13px; vertical-align: top; }
        th { background: #efefef; }
        .mono { font-family: Consolas, monospace; font-size: 12px; }
        .badge { border: 1px solid #000; padding: 1px 6px; font-size: 12px; display:inline-block; }
    </style>
</head>
<body>

<script>renderLayout();</script>

<h2>–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h2>

<div id="adminGate" class="panel" style="display:none;"></div>

<div id="adminBody" style="display:none;">

    <div class="panel">
        <h3 style="margin:0 0 8px;">–≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç –±–∞–∑—ã (–æ–¥–Ω–∏–º JSON)</h3>
        <div class="row">
            <button id="btnExport">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
            <label>
                <input id="importFile" type="file" accept="application/json" style="display:none;">
                <button id="btnImport">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
            </label>
        </div>
        <div class="hint" style="margin-top:6px;">
            –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω. –§–æ—Ä–º–∞—Ç ‚Äî JSON —Å–ª–µ–ø–æ–∫ –∫–ª—é—á–µ–π –ø—Ä–æ–µ–∫—Ç–∞ (localStorage).
        </div>
        <div id="backupStatus" class="hint" style="margin-top:6px;"></div>
    </div>

    <div class="panel">
        <h3 style="margin:0 0 8px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div class="row">
            <label>Email: <input id="newEmail" type="text" placeholder="user@example.com"></label>
            <label>–ò–º—è: <input id="newName" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò."></label>
            <label>–†–æ–ª—å:
                <select id="newRole">
                    <option value="user">user</option>
                    <option value="admin">admin</option>
                </select>
            </label>
            <label>–ü–∞—Ä–æ–ª—å: <input id="newPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
            <button id="btnCreateUser">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div class="hint" style="margin-top:6px;">
            –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω: recovery-–∫–æ–¥—ã + –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        </div>

        <div style="margin-top:10px; overflow:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>–ò–º—è</th>
                        <th>–†–æ–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="usersTbody"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <h3 style="margin:0 0 8px;">–ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–æ—Ñ–ª–∞–π–Ω)</h3>
        <div class="row">
            <button id="btnRotateMaster">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á</button>
        </div>
        <div class="hint" style="margin-top:6px;">
            –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è <b>–æ–¥–∏–Ω —Ä–∞–∑</b> –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –°–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ.
        </div>
        <div id="masterKeyBox" class="mono" style="margin-top:8px;"></div>
    </div>

</div>

<script>
(function(){
    function $(id){ return document.getElementById(id); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function gate(msgHtml){
        const box = $('adminGate');
        box.style.display = '';
        box.innerHTML = msgHtml;
        $('adminBody').style.display = 'none';
    }

    function okToShow(){
        $('adminGate').style.display = 'none';
        $('adminBody').style.display = '';
    }

    async function refreshUsers(){
        const tbody = $('usersTbody');
        tbody.innerHTML = '';

        const list = await Auth.adminListUsers();
        list.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="mono">${esc(u.id)}</td>
                <td>${esc(u.email)}</td>
                <td>${esc(u.displayName||'')}</td>
                <td><span class="badge">${esc(u.role)}</span></td>
                <td>${u.disabled ? '<span class="danger">–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' : '–∞–∫—Ç–∏–≤–µ–Ω'}</td>
                <td>
                    <button data-act="toggle" data-id="${esc(u.id)}">${u.disabled ? '–†–∞–∑–±–ª–æ–∫.' : '–ë–ª–æ–∫.'}</button>
                    <button data-act="reset" data-id="${esc(u.id)}">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-act]').forEach(b => {
            b.addEventListener('click', async ()=>{
                const act = b.getAttribute('data-act');
                const id = b.getAttribute('data-id');

                if(act === 'toggle'){
                    const u = (await Auth.adminListUsers()).find(x => x.id === id);
                    if(!u) return;
                    await Auth.adminSetDisabled(id, !u.disabled);
                    refreshUsers();
                }

                if(act === 'reset'){
                    const p = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ä–∞–∑—É):');
                    if(!p) return;
                    await Auth.adminResetPassword(id, p);
                    alert('–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω.');
                }
            });
        });
    }

    async function init(){
        // auth guard
        if (!Auth.authEnabled()){
            gate('<b>–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.</b><br>–û—Ç–∫—Ä–æ–π <a href="login.html">login.html</a> –∏ —Å–æ–∑–¥–∞–π –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            return;
        }
        if (!Auth.isLoggedIn()){
            gate('<b>–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.</b><br>–û—Ç–∫—Ä–æ–π <a href="login.html">login.html</a> –∏ –≤–æ–π–¥–∏.');
            return;
        }
        const u = await Auth.getSessionUser();
        if (!u || u.role !== 'admin'){
            gate('<b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.</b><br>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.');
            return;
        }

        okToShow();
        await refreshUsers();

        // export
        $('btnExport').addEventListener('click', async ()=>{
            const snap = Auth.exportProjectStorageSnapshot();
            const json = JSON.stringify(snap, null, 2);
            const blob = new Blob([json], {type:'application/json'});
            const a = document.createElement('a');
            const dt = new Date();
            const fn = `papajkh_backup_${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}.json`;
            a.href = URL.createObjectURL(blob);
            a.download = fn;
            document.body.appendChild(a);
            a.click();
            setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
            $('backupStatus').textContent = '–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: ' + fn;
        });

        // import
        $('btnImport').addEventListener('click', ()=> $('importFile').click());
        $('importFile').addEventListener('change', async ()=>{
            const f = $('importFile').files && $('importFile').files[0];
            if(!f) return;
            const raw = await f.text();
            try{
                const obj = JSON.parse(raw);
                const ok = confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é? –¢–µ–∫—É—â–∞—è –±–∞–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞.');
                if(!ok) return;
                Auth.importProjectStorageSnapshot(obj);
                alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
                location.href = 'index.html';
            }catch(e){
                alert('–û—à–∏–±–∫–∞ JSON: ' + (e && e.message ? e.message : e));
            }
        });

        // create user
        $('btnCreateUser').addEventListener('click', async ()=>{
            const email = ($('newEmail').value||'').trim();
            const name = ($('newName').value||'').trim();
            const role = $('newRole').value;
            const pass = ($('newPass').value||'').trim();
            if(!email || !pass){
                alert('–ù—É–∂–Ω—ã email –∏ –ø–∞—Ä–æ–ª—å.');
                return;
            }
            await Auth.adminCreateUser({ email, displayName: name, role, password: pass });
            $('newEmail').value = '';
            $('newName').value = '';
            $('newPass').value = '';
            await refreshUsers();
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω.');
        });

        // master key rotate
        $('btnRotateMaster').addEventListener('click', async ()=>{
            const ok = confirm('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á? –°—Ç–∞—Ä—ã–π –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.');
            if(!ok) return;
            await Auth.adminRotateMasterKey();
            const key = Auth.popMasterKeyOnce();
            $('masterKeyBox').innerHTML = key ? ('–ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á: <b>' + esc(key) + '</b>') : '<span class="danger">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á.</span>';
        });

        // if key was generated —Ä–∞–Ω–µ–µ –∏ –µ—â—ë –Ω–µ –ø–æ–∫–∞–∑–∞–Ω
        const maybe = Auth.popMasterKeyOnce();
        if(maybe){
            $('masterKeyBox').innerHTML = '–ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á (–ø–æ–∫–∞–∑ 1 —Ä–∞–∑): <b>' + esc(maybe) + '</b>';
        }
    }

    // –∂–¥—ë–º auth.js (defer)
    (function wait(){
        if(window.Auth && typeof Auth.getSessionUser === 'function') return init();
        setTimeout(wait, 30);
    })();
})();
</script>

<script>closeLayout();</script>

</body>
</html>
