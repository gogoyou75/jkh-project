<!DOCTYPE html>

<!-- ============================================================
üîí CRITICAL ‚Äî –ù–ï –¢–†–û–ì–ê–¢–¨ (–ü–ê–ü–ê–ñ–ö–•) | Date: 2026-01-27
Doc: docs/LOGIC_SPEC_v1.5.3.md
–≠—Ç–∞–ª–æ–Ω: jkh_site_full_v01.27.3.zip | SHA256: 6b4254a9b3b74327fe2d2c48c34e3e446ba9ae4e3369c6c554a683bde7b6ceec

- ES-modules (type="module") –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ v1.5.x (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å file://)
- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π CRITICAL: calc_engine.js –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–û payment_table.js / spravka_sud.js
- –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞ = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã; —Å–ø—Ä–∞–≤–∫–∏/–æ—Ç—á—ë—Ç—ã –Ω–µ –ª–æ–º–∞—é—Ç –∫–∞—Ä—Ç–æ—á–∫—É
============================================================ -->

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="critical_guard.js" defer></script>
    <title>–ì–ª–∞–≤–Ω–∞—è –ñ–ö–•</title>

    <link rel="stylesheet" href="style.css">

    <!-- –¥–∞–Ω–Ω—ã–µ –∏ –ª—ç–π–∞—É—Ç -->
    <script src="data.js"></script>
    <script src="calc_engine.js"></script>
<script src="layout.js"></script>

    <style>
        /* ===== –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –®–ê–ü–ö–ê ===== */
        .sticky-header thead tr:first-child th {
            position: sticky;
            top: 50px;
            background: #efefef;
            z-index: 100;
        }

        /* ===== –°–¢–ò–õ–ò –°–¢–†–ï–õ–û–ö ===== */
        .sort-arrow {
            font-size: 11px;
            padding-left: 4px;
            opacity: 0.7;
        }
        .sort-arrow.asc::after { content: "‚ñ≤"; }
        .sort-arrow.desc::after { content: "‚ñº"; }

        /* ===== –§–ò–õ–¨–¢–†–´ ===== */
        .filters-row th { padding: 1px; }
        .filters-row input {
            width: 95%;
            font-size: 11px;
            padding: 2px 4px;
            box-sizing: border-box;
        }

        /* ===== –ö–õ–ò–ö–ê–ë–ï–õ–¨–ù–´–ï –°–¢–†–û–ö–ò ===== */
        .row-clickable { cursor: pointer; }
        .row-clickable:hover td { background: #f5f5f5; }

        /* ===== –í–´–î–ï–õ–ï–ù–ò–ï –ü–û –î–û–õ–ì–£ ===== */
        .debt-low td  { background-color: #fff6e5; }
        .debt-mid td  { background-color: #ffe0e0; }
        .debt-high td { background-color: #ffcccc; font-weight: bold; }

        /* ===== PAGINATION ===== */
        #paginationInfo {
            margin: 10px 0 5px;
            font-size: 13px;
        }

        #paginationControls button {
            margin: 0 3px;
            padding: 3px 7px;
            font-size: 12px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
        }

        #paginationControls .current-page {
            font-weight: bold;
            text-decoration: underline;
        }

        #paginationControls button[disabled] {
            opacity: 0.4;
            cursor: default;
        }
    </style>
</head>
<body>

<script>renderLayout();</script>

<h2>–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ü–û –ö–ê–ñ–î–û–ú–£ –ê–ë–û–ù–ï–ù–¢–£</h2>

<table id="abonentsTable" class="sticky-header">
    <thead>
        <!-- === –®–ê–ü–ö–ê === -->
        <tr>
            <th data-field="id">
                <span class="label-text">–ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="fam">
                <span class="label-text">–§–∞–º–∏–ª–∏—è</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="name">
                <span class="label-text">–ò–º—è</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="otch">
                <span class="label-text">–û—Ç—á–µ—Å—Ç–≤–æ</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="totalDebt">
                <span class="label-text">–í—Å–µ–≥–æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="penalty">
                <span class="label-text">–ü–ï–ù–Ø –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="nachisleno">
                <span class="label-text">–ù–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="oplacheno">
                <span class="label-text">–û–ü–õ–ê–ß–ï–ù–û –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="startDate">
                <span class="label-text">–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—á—ë—Ç–∞</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="endDate">
                <span class="label-text">–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="note">
                <span class="label-text">–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-field="flatReg">
                <span class="label-text">ID –∫–≤–∞—Ä—Ç–∏—Ä—ã (regnum)</span>
                <span class="sort-arrow"></span>
            </th>
        </tr>

        <!-- === –§–ò–õ–¨–¢–†–´ === -->
        <tr class="filters-row">
            <th><input data-field="id"></th>
            <th><input data-field="fam"></th>
            <th><input data-field="name"></th>
            <th><input data-field="otch"></th>
            <th><input data-field="totalDebt"></th>
            <th><input data-field="penalty"></th>
            <th><input data-field="nachisleno"></th>
            <th><input data-field="oplacheno"></th>
            <th><input data-field="startDate"></th>
            <th><input data-field="endDate"></th>
            <th><input data-field="note"></th>
            <th><input data-field="flatReg"></th>
        </tr>
    </thead>

    <tbody></tbody>
</table>

<div id="paginationInfo"></div>
<div id="paginationControls"></div>

<script>
/* ============================================================
     –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
============================================================ */
let allRows = [];
let filteredRows = [];
let currentPage = 1;
const pageSize = 20;
let sortField = null;
let sortAsc = true;
const filters = {};

// ============================================================
// üîê CRITICAL_ASSERT (DEV)
// –í –ø—Ä–æ–¥–µ —Ç–∏—Ö–æ –ª–æ–≥–∏—Ä—É–µ–º, –≤ DEV –º–æ–∂–Ω–æ –±—Ä–æ—Å–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
// ============================================================
function CRITICAL_ASSERT(cond, msg, ctx){
    if (cond) return;
    try {
        console.error("CRITICAL_ASSERT:", msg || "assert failed", ctx || {});
    } catch(e){}
    // –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∂—ë—Å—Ç–∫–∏–π —Ä–µ–∂–∏–º: localStorage.setItem('CRITICAL_ASSERT_THROW','1')
    try {
        if (localStorage.getItem('CRITICAL_ASSERT_THROW') === '1') {
            throw new Error(String(msg || "CRITICAL_ASSERT failed"));
        }
    } catch(e){ throw e; }
}

/* ============================================================
     –î–ê–¢–´ (—Ñ–æ—Ä–º–∞—Ç/–ø–∞—Ä—Å–∏–Ω–≥)
============================================================ */
function pad2(n){ return String(n).padStart(2, "0"); }

function formatDMY(d){
    if (!d || d.toString() === "Invalid Date") return "";
    return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear()}`;
}

function parseDateDMY(str) {
    if (!str) return null;
    const p = String(str).split(".");
    if (p.length !== 3) return null;
    const d = new Date(+p[2], +p[1] - 1, +p[0]);
    return d.toString() === "Invalid Date" ? null : d;
}

function escapeHtml(str){
    return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
}

// –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ISO YYYY-MM-DD –∏ RU DD.MM.YYYY (–∫–∞–∫ –≤ payment_table.js)
function parseDateAnyToDate(value) {
    if (value === null || value === undefined) return null;
    const s = String(value || "").trim();
    if (!s) return null;

    // CRITICAL: ISO YYYY-MM-DD –Ω–µ–ª—å–∑—è –ø–∞—Ä—Å–∏—Ç—å —á–µ—Ä–µ–∑ new Date(iso) (UTC-—Å–¥–≤–∏–≥).
    // –†–∞–∑–±–∏—Ä–∞–µ–º –≤—Ä—É—á–Ω—É—é –∏ —Å–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∞—Ç—É –≤ 12:00.
    let m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m1) {
        const y = Number(m1[1]);
        const mo = Number(m1[2]);
        const d = Number(m1[3]);
        const dt = new Date(y, mo - 1, d, 12, 0, 0);
        return dt.toString() === "Invalid Date" ? null : dt;
    }

    // RU: DD.MM.YYYY (–¥–æ–ø—É—Å–∫–∞–µ–º 1-2 —Ü–∏—Ñ—Ä—ã)
    m1 = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if (m1) {
        const dd = Number(m1[1]);
        const mm = Number(m1[2]);
        const yy = Number(m1[3]);
        const dt = new Date(yy, mm - 1, dd, 12, 0, 0);
        return dt.toString() === "Invalid Date" ? null : dt;
    }

    const d2 = new Date(s);
    if (d2.toString() === "Invalid Date") return null;
    return new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(), 12, 0, 0);
}
function parseDateForSort(str){
    // –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö startDate/endDate —É –Ω–∞—Å –î–î.–ú–ú.–ì–ì–ì–ì
    return parseDateDMY(str);
}

/* ============================================================
     ‚úÖ –ß–¢–ï–ù–ò–ï –ò–¢–û–ì–û–í –ò –î–ê–¢ –ò–ó payments_<id>
============================================================ */
function toNum(v){
    const n = parseFloat(String(v ?? "").replace(",", ".").replace(/\s+/g,""));
    return isNaN(n) ? 0 : n;
}


function getAbonentNote(id, a){
    // 1) –∏–∑ AbonentsDB –ø–æ–ª–µ–π
    const fromA = (a && (a.defaultNote || a.note || a.comment || a.prim || a.primNote || a.noteText)) ? (a.defaultNote || a.note || a.comment || a.prim || a.primNote || a.noteText) : "";
    if (String(fromA || "").trim()) return String(fromA);

    // 2) –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª—é—á (–µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞)
    try{
        const raw = localStorage.getItem("note_" + String(id));
        if (raw !== null && raw !== undefined) return String(raw);
    }catch(e){}

    return "";
}

function getPaymentsForAbonent(id){
    try{
        const raw = localStorage.getItem("payments_" + id);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
    }catch{
        return [];
    }
}

// –ò—Ç–æ–≥–∏ + –¥–∞—Ç—ã:
// - –ù–∞—á–∏—Å–ª–µ–Ω–æ/–û–ø–ª–∞—á–µ–Ω–æ: —Å—É–º–º—ã accrued/paid
// - –ü–µ–Ω—è/–í—Å–µ–≥–æ: –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º total_debt (–Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–π –∏—Ç–æ–≥)
// - startDate: min(paid_date)
// - endDate (—É–º–Ω–æ):
//    - –µ—Å–ª–∏ totalDebt > 0 -> —Å–µ–≥–æ–¥–Ω—è
//    - –µ—Å–ª–∏ totalDebt == 0 -> max(paid_date)
function calcTotalsFromPayments(id, abonentObj){
    const arr = getPaymentsForAbonent(id);
    if (!arr.length) return null;

    let sumAcc = 0;
    let sumPaid = 0;

    for (const r of arr){
        sumAcc += toNum(r.accrued);
        sumPaid += toNum(r.paid);
    }

    // ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ "–í—Å–µ–≥–æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å" –∏ "–ü–ï–ù–Ø –∑–∞ –ø–µ—Ä–∏–æ–¥" –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ª–æ–≥–∏–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏.
    // –í–∞–∂–Ω–æ: –≤ LS —Å—Ç—Ä–æ–∫–∏ payments_<id> –º–æ–≥—É—Ç –ù–ï —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ total_debt/pay_penalty,
    // –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ "–Ω–∞ –ª–µ—Ç—É".
    // –ü–æ—ç—Ç–æ–º—É:
    //   1) –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω calc_engine (JKHCalcEngine) ‚Äî —Å—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (—ç—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
    //   2) –∏–Ω–∞—á–µ ‚Äî fallback –∫ –¥–∞–Ω–Ω—ã–º –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–µ—Å—è—Ü–∞.

    let totalDebt = 0;
    let penalty = 0;

    // (1) –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å ‚Äî —á–µ—Ä–µ–∑ calc_engine
    try {
        if (window.JKHCalcEngine) {
            // ‚úÖ –ï–î–ò–ù–´–ô –î–í–ò–ñ–û–ö: –¥–ª—è —Å–≤–æ–¥–Ω–æ–π –≥–ª–∞–≤–Ω–æ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥,
            // —á—Ç–æ –∏ –∫–∞—Ä—Ç–æ—á–∫–∞/—Å–ø—Ä–∞–≤–∫–∞: calcTotalsAsOfAdjusted() –Ω–∞ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞.
            //
            // –í–ê–ñ–ù–û:
            // - calcTotalsAsOfCore() –æ—Ç–¥–∞—ë—Ç "–Ω–∞—á–∏—Å–ª–µ–Ω–Ω—É—é –ø–µ–Ω—é" (penaltyAccruedTotal) ‚Äî —ç—Ç–æ –î–†–£–ì–û–ï.
            // - –Ω–∞–º –Ω—É–∂–Ω–∞ "–ø–µ–Ω—è –∫ –≤–∑—ã—Å–∫–∞–Ω–∏—é / –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –ø–µ–Ω–∏" (penaltyDebt),
            //   –∫–æ—Ç–æ—Ä–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π –∏ —Å–ø—Ä–∞–≤–∫–æ–π.
            const asOf = new Date(); // –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π = —Å–µ–≥–æ–¥–Ω—è
            if (typeof window.JKHCalcEngine.calcTotalsAsOfAdjusted === 'function') {
                const adj = window.JKHCalcEngine.calcTotalsAsOfAdjusted(
                    arr,
                    asOf,
                    { abonentId: id, applyAdvanceOffset: true, allowNegativePrincipal: true }
                );

                const principal = Number(adj?.principal) || 0;       // –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (–∞–≤–∞–Ω—Å)
                const penDebt   = Number(adj?.penaltyDebt) || 0;
                const total     = Number(adj?.total) || (principal + penDebt);

                totalDebt = total;
                // üî¥ CRITICAL: –µ—Å–ª–∏ –∏—Ç–æ–≥ <= 0 (–Ω–µ—Ç –¥–æ–ª–≥–∞/–∞–≤–∞–Ω—Å) ‚Äî –ø–µ–Ω—è –≤ —Å–≤–æ–¥–Ω–æ–π = 0
                penalty = (totalDebt > 0.0000001) ? penDebt : 0;

                CRITICAL_ASSERT(Number.isFinite(totalDebt), "Index: totalDebt is not finite", { id, totalDebt, adj });
                CRITICAL_ASSERT(Number.isFinite(penalty),   "Index: penalty is not finite",   { id, penalty, adj });
            } else {
                throw new Error('JKHCalcEngine.calcTotalsAsOfAdjusted is missing');
            }
        } else {
            throw new Error('no JKHCalcEngine');
        }
    } catch (e) {
        // (2) fallback ‚Äî –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–µ—Å—è—Ü–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        let endRow = null;
        let bestKey = -Infinity;
        let bestIsAccr = false;
        let bestId = -Infinity;

        for (const r of arr){
            const y = Number(r.year) || 0;
            const m = Number(r.month) || 0;
            const key = (y * 12) + m;
            const isAccr = Math.abs(toNum(r.accrued)) > 0.0000001;

            const rid = Number(r.id) || 0;

            const better =
                (key > bestKey) ||
                (key === bestKey && isAccr && !bestIsAccr) ||
                (key === bestKey && isAccr === bestIsAccr && rid >= bestId);

            if (better){
                bestKey = key;
                bestIsAccr = isAccr;
                bestId = rid;
                endRow = r;
            }
        }

        totalDebt = endRow ? toNum(endRow.total_debt) : 0;
        penalty   = endRow ? toNum(endRow.pay_penalty) : 0;

        if (totalDebt <= 0.0000001) penalty = 0;
    }

    // ‚úÖ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ total_debt –≤ —Å—Ç—Ä–æ–∫–∞—Ö –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω (0), –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –∞–≤–∞–Ω—Å/–¥–æ–ª–≥ –ø–æ —Å—É–º–º–∞–º
    // principalNet = –Ω–∞—á–∏—Å–ª–µ–Ω–æ - –æ–ø–ª–∞—á–µ–Ω–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å < 0)
    const principalNet = sumAcc - sumPaid;
    if (Math.abs(totalDebt) <= 0.0000001 && Math.abs(principalNet) > 0.0000001) {
        totalDebt = principalNet + penalty;
    }

    // –ø—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ –∏—Ç–æ–≥–æ–≤—ã–π –¥–æ–ª–≥ <= 0 (–∞–≤–∞–Ω—Å/–Ω–æ–ª—å) ‚Äî –ø–µ–Ω—è –≤ —Å–≤–æ–¥–Ω–æ–π = 0, –∞ "–í—Å–µ–≥–æ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å" = —Ç–æ–ª—å–∫–æ principalNet
    if (totalDebt <= 0.0000001) {
        penalty = 0;
        if (Math.abs(principalNet) > 0.0000001) totalDebt = principalNet;
    }

    // ‚úÖ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—á—ë—Ç–∞ = –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–±–æ–Ω–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞)
    let startDate = "";
    const regRaw = abonentObj?.regDate || abonentObj?.registrationDate || abonentObj?.reg_date || abonentObj?.date_reg || abonentObj?.registeredAt;
    const regD = parseDateAnyToDate(regRaw);
    if (regD) startDate = formatDMY(regD);

    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Ç: –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü –∏–∑ –¥–∞–Ω–Ω—ã—Ö
    if (!startDate){
        let minKey = Infinity;
        let minY = 0, minM = 0;
        for (const r of arr){
            const y = Number(r.year) || 0;
            const m = Number(r.month) || 0;
            const key = (y * 12) + m;
            if (key && key < minKey){
                minKey = key;
                minY = y; minM = m;
            }
        }
        if (minKey !== Infinity && minY && minM){
            startDate = formatDMY(new Date(minY, minM-1, 1));
        }
    }

    // ‚úÖ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞ –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
    const endDate = formatDMY(new Date());

    return {
        nachisleno: Math.abs(sumAcc)  > 0.0000001 ? sumAcc.toFixed(2)  : "",
        oplacheno:  Math.abs(sumPaid) > 0.0000001 ? sumPaid.toFixed(2) : "",
        totalDebt:  Math.abs(totalDebt) > 0.0000001 ? totalDebt.toFixed(2) : "",
        penalty:    Math.abs(penalty)   > 0.0000001 ? penalty.toFixed(2)   : "",
        startDate:  startDate,
        endDate:    endDate
    };
}

/* ============================================================
     –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó data.js + (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏) –∏–∑ payments_<id>
============================================================ */
document.addEventListener("DOMContentLoaded", () => {

    const db = window.AbonentsDB?.abonents || {};

    for (const id in db) {
        const a = db[id];

        const fio = (a.fio || "").split(" ");
        const fam = fio[0] || "";
        const name = fio[1] || "";
        const otch = fio[2] || "";

        const totals = calcTotalsFromPayments(id, a);

        allRows.push({
            id,
            fam,
            name,
            otch,

            // ‚úÖ –µ—Å–ª–∏ –µ—Å—Ç—å payments_<id> ‚Äî –±–µ—Ä—ë–º –∏—Ç–æ–≥–∏ –∏–∑ –Ω–∏—Ö
            totalDebt: (totals?.totalDebt ?? a.totalDebt ?? a.total_debt ?? a.mainDebtTotal ?? ""),
            penalty:   (totals?.penalty   ?? a.penalty ?? a.penaltyTotal ?? ""),

            nachisleno: (totals?.nachisleno ?? ""),
            oplacheno:  (totals?.oplacheno  ?? ""),

            startDate:  (totals?.startDate ?? ""),
            endDate:    (totals?.endDate   ?? ""),

            note: getAbonentNote(id, a),
            flatReg: (a.regnum || a.premiseRegnum || a.premise_regnum || a.regNumber || a.reg_no || a.flat || '')
        });
    }

    initFilters();
    initSorting();
    render();
});

/* ============================================================
     –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–ò–õ–¨–¢–†–û–í
============================================================ */
function initFilters() {
    document.querySelectorAll(".filters-row input").forEach(input => {
        const field = input.dataset.field;
        filters[field] = "";

        input.addEventListener("input", () => {
            filters[field] = input.value;
            currentPage = 1;
            render();
        });
    });
}

/* ============================================================
     –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–û–†–¢–ò–†–û–í–ö–ò (—Å–æ —Å—Ç—Ä–µ–ª–∫–∞–º–∏)
============================================================ */
function initSorting() {
    const headers = document.querySelectorAll("thead tr:first-child th");

    headers.forEach(th => {
        const field = th.dataset.field;
        if (!field) return;

        th.style.cursor = "pointer";

        th.addEventListener("click", () => {
            if (sortField === field) sortAsc = !sortAsc;
            else {
                sortField = field;
                sortAsc = true;
            }
            render();
        });
    });
}

/* ============================================================
     –û–°–ù–û–í–ù–û–ô –†–ï–ù–î–ï–† (—Ñ–∏–ª—å—Ç—Ä—ã + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ + –ø–∞–≥–∏–Ω–∞—Ü–∏—è)
============================================================ */
function render() {
    /* --- —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è --- */
    filteredRows = allRows.filter(r => {
        for (const f in filters) {
            const val = String(filters[f] ?? "").toLowerCase().trim();
            if (!val) continue;
            if (!String(r[f] ?? "").toLowerCase().includes(val)) return false;
        }
        return true;
    });

    /* --- —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ --- */
    if (sortField) {
        filteredRows.sort((a, b) => {
            let A = String(a[sortField] ?? "").trim();
            let B = String(b[sortField] ?? "").trim();

            const dA = parseDateForSort(A);
            const dB = parseDateForSort(B);
            if (dA && dB) return sortAsc ? dA - dB : dB - dA;

            const nA = parseFloat(A.replace(/\s+/g, ""));
            const nB = parseFloat(B.replace(/\s+/g, ""));
            if (!isNaN(nA) && !isNaN(nB)) return sortAsc ? nA - nB : nB - nA;

            return sortAsc ? A.localeCompare(B, "ru") : B.localeCompare(A, "ru");
        });
    }

    /* --- –ø–∞–≥–∏–Ω–∞—Ü–∏—è --- */
    const total = filteredRows.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const startIndex = (currentPage - 1) * pageSize;
    const pageRows = filteredRows.slice(startIndex, startIndex + pageSize);

    /* --- –≤—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫ --- */
    const tbody = document.querySelector("#abonentsTable tbody");
    tbody.innerHTML = "";

    pageRows.forEach(r => {
        const tr = document.createElement("tr");
        tr.classList.add("row-clickable");
        tr.dataset.id = r.id;

        const debt = parseFloat((r.totalDebt || "").toString().replace(/\s+/g, ""));
        const pen = parseFloat((r.penalty || "").toString().replace(/\s+/g, ""));
        if ((debt > 0.0000001) || (!isNaN(pen) && pen > 0.0000001)) tr.classList.add("has-debt");
        if (!isNaN(debt)) {
            if (debt > 50000) tr.classList.add("debt-high");
            else if (debt > 10000) tr.classList.add("debt-mid");
            else if (debt > 0) tr.classList.add("debt-low");
        }

        tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.fam}</td>
            <td>${r.name}</td>
            <td>${r.otch}</td>
            <td>${r.totalDebt}</td>
            <td>${r.penalty}</td>
            <td>${r.nachisleno}</td>
            <td>${r.oplacheno}</td>
            <td>${r.startDate}</td>
            <td>${r.endDate}</td>
            <td><textarea class="note-inline note-abonent" data-id="${r.id}" placeholder="">${escapeHtml(String(r.note||""))}</textarea></td>
            <td>${r.flatReg}</td>
        `;
        tbody.appendChild(tr);
    });

    /* --- –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –∫–ª–∏–∫—É --- */
    tbody.onclick = (e) => {
        // –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ textarea/–∏–Ω–ø—É—Ç—É ‚Äî –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–∞—Ä—Ç–æ—á–∫—É
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if (tag === "textarea" || tag === "input" || tag === "select" || tag === "button") return;

        const tr = e.target.closest("tr");
        if (tr) {
            window.location.href = "abonent_card.html?abonent=" + encodeURIComponent(tr.dataset.id);
        }
    };

    
    // --- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞" –ø—Ä—è–º–æ –∏–∑ –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü—ã ---
    // –•—Ä–∞–Ω–∏–º –≤ AbonentsDB.abonents[id].defaultNote –∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–µ–∑ saveAbonentsDB (–µ—Å–ª–∏ –µ—Å—Ç—å).
    tbody.querySelectorAll("textarea.note-abonent").forEach(ta => {
        ta.addEventListener("click", (ev) => ev.stopPropagation());
        ta.addEventListener("keydown", (ev) => ev.stopPropagation());
        ta.addEventListener("blur", () => {
            const id = String(ta.dataset.id || "").trim();
            if (!id) return;
            const val = String(ta.value || "");

            try{
                if (window.AbonentsDB && window.AbonentsDB.abonents && window.AbonentsDB.abonents[id]){
                    window.AbonentsDB.abonents[id].defaultNote = val;
                }
            }catch(e){}

            // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
            try{ localStorage.setItem("note_" + id, val); }catch(e){}

            // –µ—Å–ª–∏ –≤ data.js –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            try{
                if (typeof window.saveAbonentsDB === "function") window.saveAbonentsDB();
                else if (typeof window.saveDB === "function") window.saveDB();
                else {
                    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: —Ç–∏–ø–∏—á–Ω—ã–π –∫–ª—é—á –±–∞–∑—ã (–µ—Å–ª–∏ data.js —Ö—Ä–∞–Ω–∏—Ç –µ—ë –≤ LS)
                    localStorage.setItem("abonents_db_v1", JSON.stringify(window.AbonentsDB));
                }
            }catch(e){}
        });
    });
/* --- —Å—Ç—Ä–µ–ª–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ --- */
    document.querySelectorAll("thead tr:first-child th").forEach(th => {
        const field = th.dataset.field;
        const arrow = th.querySelector(".sort-arrow");
        if (!arrow) return;

        if (field === sortField) {
            arrow.classList.remove("asc", "desc");
            arrow.classList.add(sortAsc ? "asc" : "desc");
        } else {
            arrow.classList.remove("asc", "desc");
        }
    });

    /* --- –ø–∞–≥–∏–Ω–∞—Ü–∏—è --- */
    renderPagination(total, startIndex + 1, startIndex + pageRows.length);
}

/* ============================================================
     PAGINATION
============================================================ */
function renderPagination(total, from, to) {
    const info = document.getElementById("paginationInfo");
    const controls = document.getElementById("paginationControls");

    if (total === 0) {
        info.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        controls.innerHTML = "";
        return;
    }

    info.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${from}‚Äì${to} –∏–∑ ${total}`;

    const totalPages = Math.max(1, Math.ceil(total / pageSize));

    controls.innerHTML = "";

    function btn(label, page, disabled, current) {
        const b = document.createElement("button");
        b.textContent = label;
        if (disabled) b.disabled = true;
        if (current) b.classList.add("current-page");
        if (!disabled) b.onclick = () => {
            currentPage = page;
            render();
        };
        controls.appendChild(b);
    }

    btn("‚èÆ", 1, currentPage === 1);
    btn("‚óÄ", currentPage - 1, currentPage === 1);

    const min = Math.max(1, currentPage - 2);
    const max = Math.min(totalPages, currentPage + 2);

    for (let p = min; p <= max; p++) {
        btn(String(p), p, false, p === currentPage);
    }

    btn("‚ñ∂", currentPage + 1, currentPage === totalPages);
    btn("‚è≠", totalPages, currentPage === totalPages);
}
</script>

<script>closeLayout();</script>

</body>
</html>
