<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ç—á—ë—Ç: –∫—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</title>
  <link rel="stylesheet" href="style.css">
  <script src="data.js"></script>
  <script src="layout.js"></script>
  <style>
    .card{border:2px solid #000; background:#fff; padding:14px; margin-top:10px;}
    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{border:2px solid #000; padding:6px; vertical-align:top;}
    .muted{opacity:.8; font-size:12px;}
    .row{display:flex; gap:10px; align-items:end; flex-wrap:wrap;}
    .row label{font-size:13px; display:flex; flex-direction:column; gap:6px;}
    input{border:2px solid #000; height:28px; padding:2px 6px; font-size:13px;}
    button{border:2px solid #000; padding:6px 10px; background:#e5e5e5; cursor:pointer;}
    @media print {
      .no-print{display:none !important;}
      body{background:#fff;}
    }
  </style>
</head>
<body>
<script>renderLayout();</script>

<h2>–û—Ç—á—ë—Ç –¥–ª—è —Å—É–¥–∞: –∫—Ç–æ –±—ã–ª –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º</h2>

<div class="card">
  <div id="hdr" style="font-weight:700;"></div>
  <div class="muted" style="margin-top:6px;">
    üî¥ CRITICAL: –æ—Ç—á—ë—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (links). –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è –∞–±–æ–Ω–µ–Ω—Ç–∞ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è.
  </div>

  <div class="row no-print" style="margin-top:12px;">
    <label>–ü–µ—Ä–∏–æ–¥ —Å
      <input type="date" id="from">
    </label>
    <label>–ø–æ
      <input type="date" id="to">
    </label>
    <button type="button" onclick="run()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
    <button type="button" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
    <button type="button" onclick="history.back()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<div class="card">
  <div style="font-weight:700; margin-bottom:8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
  <table>
    <thead>
      <tr>
        <th style="width:170px;">–ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞)</th>
        <th style="width:90px;">–õ–°</th>
        <th>–§–ò–û</th>
        <th style="width:140px;">–û—Å–Ω–æ–≤–∞–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
function q(name){ return document.getElementById(name); }
function getLinks(){ return Array.isArray(window.AbonentsDB?.links) ? window.AbonentsDB.links : []; }
function getDb(){ return window.AbonentsDB?.abonents || {}; }
function getPremises(){ return window.AbonentsDB?.premises || {}; }

function parseISO(s){
  const v = String(s||'').trim();
  if(!v) return null;
  const d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}
function fmtISO(d){
  if(!d) return '';
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function maxDate(a,b){ return a && b ? (a>b?a:b) : (a||b); }
function minDate(a,b){ return a && b ? (a<b?a:b) : (a||b); }

function splitByPeriod(regnum, from, to){
  const r = String(regnum||'').trim();
  const links = getLinks()
    .filter(l => String(l?.regnum||'').trim() === r)
    .slice()
    .sort((a,b) => String(a?.dateFrom||'').localeCompare(String(b?.dateFrom||'')));

  // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã links: [dateFrom, dateTo||‚àû)
  const result = [];
  links.forEach(l => {
    const df = parseISO(l.dateFrom);
    const dt = parseISO(l.dateTo) || null; // null = –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
    if(!df) return;

    // –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å [from,to]
    const segFrom = from ? maxDate(df, from) : df;
    const segTo   = to ? minDate(dt || to, to) : dt;

    // —É—Å–ª–æ–≤–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è: segFrom <= segTo (–µ—Å–ª–∏ segTo null ‚Äî –æ–∫)
    if(segTo && segFrom > segTo) return;
    if(!segTo && to && segFrom > to) return;

    result.push({
      abonentId: String(l.abonentId||'').trim(),
      from: segFrom,
      to: segTo, // –º–æ–∂–µ—Ç –±—ã—Ç—å null
      reason: '–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (links)'
    });
  });

  return result;
}

function run(){
  const params = new URLSearchParams(location.search);
  const regnum = params.get('regnum') || '';
  const r = String(regnum).trim();
  if(!r){ alert('–ù–µ—Ç regnum'); return; }

  const from = parseISO(q('from').value);
  const to = parseISO(q('to').value);
  if(from && to && from > to){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –¥–∞—Ç–∞ "—Å" –±–æ–ª—å—à–µ "–ø–æ"'); return; }

  const p = getPremises()[r] || null;
  const addr = p ? [p.city,p.street,p.house,p.flat].filter(Boolean).join(', ') : '';
  q('hdr').textContent = `–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${r}${addr ? ' ‚Äî ' + addr : ''}`;

  const rows = q('rows');
  rows.innerHTML = '';
  const db = getDb();

  const segs = splitByPeriod(r, from, to);
  if(!segs.length){
    rows.innerHTML = `<tr><td colspan="4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</td></tr>`;
    return;
  }

  segs.forEach(s => {
    const fio = String(db[s.abonentId]?.fio || '').trim();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtISO(s.from)} ‚Äî ${s.to ? fmtISO(s.to) : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}</td>
      <td>${s.abonentId}</td>
      <td>${fio || '‚Äî'}</td>
      <td>${s.reason}</td>
    `;
    rows.appendChild(tr);
  });
}

// –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞—Ç—ã (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)
(function init(){
  const params = new URLSearchParams(location.search);
  const regnum = params.get('regnum') || '';
  const r = String(regnum).trim();
  const p = getPremises()[r] || null;
  const addr = p ? [p.city,p.street,p.house,p.flat].filter(Boolean).join(', ') : '';
  q('hdr').textContent = r ? `–ö–≤–∞—Ä—Ç–∏—Ä–∞: ${r}${addr ? ' ‚Äî ' + addr : ''}` : '–ö–≤–∞—Ä—Ç–∏—Ä–∞: ‚Äî';

  const now = new Date();
  const from = new Date(now.getFullYear(), now.getMonth(), 1);
  const to = new Date(now.getFullYear(), now.getMonth()+1, 0);
  q('from').value = fmtISO(from);
  q('to').value = fmtISO(to);

  if(r) run();
})();
</script>

<script>closeLayout();</script>
</body>
</html>
