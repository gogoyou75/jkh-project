<!DOCTYPE html>

<!-- ============================================================
üîí CRITICAL ‚Äî –ù–ï –¢–†–û–ì–ê–¢–¨ (–ü–ê–ü–ê–ñ–ö–•) | Date: 2026-01-27
Doc: docs/LOGIC_SPEC_v1.5.3.md
–≠—Ç–∞–ª–æ–Ω: jkh_site_full_v01.27.3.zip | SHA256: 6b4254a9b3b74327fe2d2c48c34e3e446ba9ae4e3369c6c554a683bde7b6ceec

- ES-modules (type="module") –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ v1.5.x (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å file://)
- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π CRITICAL: calc_engine.js –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–û payment_table.js / spravka_sud.js
- –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞ = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã; —Å–ø—Ä–∞–≤–∫–∏/–æ—Ç—á—ë—Ç—ã –Ω–µ –ª–æ–º–∞—é—Ç –∫–∞—Ä—Ç–æ—á–∫—É
============================================================ -->

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <script src="critical_guard.js" defer></script>
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞</title>
    <link rel="stylesheet" href="style.css">

    <script src="constants.js"></script>
    <script src="data.js"></script>
    <script src="layout.js"></script>

    <!-- üî¥ CRITICAL: –¥–≤–∏–∂–æ–∫ –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–π -->
    <script src="autoaccrual_engine.js"></script>

     <!-- —Ç–∞–±–ª–∏—Ü–∞ –æ–ø–ª–∞—Ç / –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π -->
    <script src="calc_engine.js"></script>
     <script src="payment_table.js"></script>


    <style>
        .uid-click{ cursor:pointer; text-decoration: underline; }

        .edit-link {
            font-size: 13px;
            margin-left: 14px;
            cursor: pointer;
            text-decoration: underline;
            font-weight: normal;
        }

        #abonentEditModal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 6000;
        }

        #changeResponsibleModal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 6500;
        }
        .change-resp-card {
            width: 560px;
            background: #fff;
            border: 2px solid #000;
            padding: 18px;
            box-sizing: border-box;
        }
        .change-resp-card label {
            font-size: 13px;
            display: block;
            margin-top: 10px;
        }
        .change-resp-card input,
        .change-resp-card select {
            width: 100%;
            border: 2px solid #000;
            height: 28px;
            padding: 2px 6px;
            box-sizing: border-box;
            font-size: 13px;
        }
        .change-resp-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 16px;
        }
        .change-resp-actions button {
            border: 2px solid #000;
            padding: 6px 10px;
            cursor: pointer;
            background: #fff;
        }
        .abonent-edit-card {
            width: 560px;
            background: #fff;
            border: 2px solid #000;
            padding: 18px 18px 16px 18px;
            box-sizing: border-box;
        }
        .abonent-edit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 12px;
            margin-top: 10px;
        }
        .abonent-edit-grid label {
            font-size: 13px;
        }
        .abonent-edit-grid input,
        .abonent-edit-grid select {
            width: 100%;
            border: 2px solid #000;
            height: 28px;
            padding: 2px 6px;
            box-sizing: border-box;
            font-size: 13px;
        }
        .abonent-edit-grid .full {
            grid-column: 1 / -1;
        }
        .abonent-edit-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 14px;
        }
        .abonent-edit-actions button {
            border: 2px solid #000;
            padding: 8px 12px;
            background: #e5e5e5;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        .readonly-hint {
            font-size: 12px;
            opacity: 0.85;
        }

        /* ===== –í–´–†–ê–í–ù–ò–í–ê–ù–ò–ï –®–ò–†–ò–ù –ö–û–õ–û–ù–û–ö "–û–ë–©–ò–ï –î–ê–ù–ù–´–ï" ===== */
        #abonentInfoTable { width: 100%; table-layout: fixed; }
        #abonentInfoTable th, #abonentInfoTable td{
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== –ö–≤–∞—Ä—Ç–∏—Ä–∞ / –ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å ===== */
        .premise-card {
            margin-top: 10px;
            border: 2px solid #000;
            padding: 12px;
            background: #fff;
        }
        .premise-card .premise-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 8px;
        }
        .premise-card .premise-title {
            font-size: 16px;
            font-weight: 700;
        }
        .premise-card .premise-sub {
            font-size: 12px;
        }
        .premise-card .premise-grid {
            display: grid;
            grid-template-columns: 210px 1fr;
            gap: 6px 12px;
            font-size: 13px;
        }
        .premise-card .premise-grid .k {
            font-weight: 700;
        }
        .premise-card .premise-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }

    </style>
</head>
<body>

<script>renderLayout();</script>

<h2>–ö–∞—Ä—Ç–æ—á–∫–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞</h2>

<h3 id="abonentTitle">
    –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    <span class="edit-link" onclick="openAbonentEdit()">–∏–∑–º–µ–Ω–∏—Ç—å</span>
</h3>

<table id="abonentInfoTable">
    <!-- ===== —Ñ–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—ã –ø–æ–¥ 14 –∫–æ–ª–æ–Ω–æ–∫ (—Å —É–ª–∏—Ü–µ–π) ===== -->
    <colgroup>
        <col style="width:7%">  <!-- –ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç -->
        <col style="width:9%">  <!-- —Ä–µ–≥. ‚Ññ –∫–≤ -->
        <col style="width:9%">  <!-- –§–∞–º–∏–ª–∏—è -->
        <col style="width:8%">  <!-- –ò–º—è -->
        <col style="width:8%">  <!-- –û—Ç—á–µ—Å—Ç–≤–æ -->
        <col style="width:6%">  <!-- –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å -->
        <col style="width:6%">  <!-- –ø—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ -->
        <col style="width:6%">  <!-- –∫–æ–ª –∫–æ–º–Ω–∞—Ç -->
        <col style="width:7%">  <!-- –≥–æ—Ä–æ–¥ -->
        <col style="width:10%"> <!-- —É–ª–∏—Ü–∞ -->
        <col style="width:5%">  <!-- –¥–æ–º -->
        <col style="width:4%">  <!-- –∫–≤ -->
        <col style="width:6%">  <!-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID -->
        <col style="width:9%">  <!-- —Ç–µ–ª–µ—Ñ–æ–Ω -->
    </colgroup>

    <thead>
    <tr>
        <th>–ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</th>
        <th>—Ä–µ–≥. ‚Ññ –∫–≤</th>
        <th>–§–∞–º–∏–ª–∏—è</th>
        <th>–ò–º—è</th>
        <th>–û—Ç—á–µ—Å—Ç–≤–æ</th>
        <th>–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å</th>
        <th>–ø—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</th>
        <th>–∫–æ–ª –∫–æ–º–Ω–∞—Ç</th>
        <th>–≥–æ—Ä–æ–¥</th>
        <th>—É–ª–∏—Ü–∞</th>
        <th>–¥–æ–º</th>
        <th>–∫–≤</th>
        <th>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</th>
        <th>—Ç–µ–ª–µ—Ñ–æ–Ω</th>
    </tr>
    </thead>
    <tbody id="abonentInfoBody"></tbody>
</table>


<div class="premise-card" id="premiseCard">
    <div class="premise-head">
        <div>
            <div class="premise-title">–ö–≤–∞—Ä—Ç–∏—Ä–∞ / –ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å</div>
            <div class="premise-sub muted">–î–∞–Ω–Ω—ã–µ –ø–æ –æ–±—ä–µ–∫—Ç—É (–∫–≤–∞—Ä—Ç–∏—Ä–∞) –∏ —Ç–µ–∫—É—â–µ–º—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É</div>
        </div>
    </div>

    <div class="premise-grid">
        <div class="k">–†–µ–≥. ‚Ññ –∫–≤</div><div><span id="premiseRegnum">‚Äî</span></div>
        <div class="k">–ê–¥—Ä–µ—Å</div><div><span id="premiseAddress">‚Äî</span></div>
        <div class="k">–ü–ª–æ—â–∞–¥—å</div><div><span id="premiseSquare">‚Äî</span></div>
        <div class="k">–ö–≤–∞—Ä—Ç–∏—Ä–∞ –∑–∞–≤–µ–¥–µ–Ω–∞</div><div><span id="premiseCreatedAt">‚Äî</span></div>
        <div class="k">–¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div><div><span id="premiseResponsible">‚Äî</span></div>
        <div class="k">–ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</div><div><span id="premisePeriod">‚Äî</span></div>
        <div class="k">–ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (—ç—Ç–æ—Ç –∞–±–æ–Ω–µ–Ω—Ç)</div><div><span id="premiseMyPeriod">‚Äî</span></div>
    </div>

    <div class="premise-actions">
        <button class="btn" type="button" onclick="openChangeResponsibleModal()">–°–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</button>
            <button class="btn" type="button" onclick="openResponsibilityReport()">–û—Ç—á—ë—Ç: –∫—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</button>
    </div>

<div style="margin-top:12px;">
  <div style="font-weight:700; margin-bottom:6px;">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ</div>
  <table id="respHistoryTable" style="width:100%; border-collapse:collapse; font-size:13px;">
    <thead>
      <tr>
        <th style="border:2px solid #000; padding:6px; width:160px;">–ü–µ—Ä–∏–æ–¥</th>
        <th style="border:2px solid #000; padding:6px; width:90px;">–õ–°</th>
        <th style="border:2px solid #000; padding:6px;">–§–ò–û</th>
        <th style="border:2px solid #000; padding:6px; width:90px;">–°—Ç–∞—Ç—É—Å</th>
        <th style="border:2px solid #000; padding:6px; width:130px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
      </tr>
    </thead>
    <tbody id="respHistoryBody"></tbody>
  </table>
  <div class="readonly-hint" style="margin-top:6px;">
    üî¥ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π/–æ–ø–ª–∞—Ç –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (links).
  </div>
</div>

</div>


<div class="options">
    <label onclick="location.href='exclude_period.html?abonent=' + encodeURIComponent(getAbonentIdFromURL())"
           style="cursor:pointer; text-decoration:underline;">
        –ò—Å–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–∏–æ–¥ —Ä–∞—Å—á—ë—Ç–∞
    </label>

    <label>
        –ú–æ—Ä–∞—Ç–æ—Ä–∏–π
        <input type="checkbox" id="moratoriumToggle">
    </label>

    <label onclick="openNotesModal()"
           style="cursor:pointer; text-decoration:underline;">
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞
    </label>
</div>

<div class="calc-inline">
    <div class="calc-inline-title">
        <b>–†–ê–°–ß–Å–¢ –í–ó–´–°–ö–ò–í–ê–ï–ú–û–ô –°–£–ú–ú–´</b> <span class="calc-inline-sub">–∑–∞ –ø–µ—Ä–∏–æ–¥:</span>
    </div>

    <div class="calc-inline-fields">
        <input id="calcFrom" type="date" value="">
        <input id="calcTo" type="date" value="">
    </div>

    <div class="calc-inline-actions">
        <button class="calc-btn" id="calcRunBtn" type="button">—Ä–∞—Å—á—ë—Ç</button>
        <button class="calc-btn" id="calcReportsBtn" type="button">—Å–ø—Ä–∞–≤–∫–∏</button>
        <button class="calc-btn" id="calcResetBtn" type="button">—Å–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
</div>

<h3>–û–ø–ª–∞—Ç–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>

<div class="note" style="margin:6px 0 10px 0; font-size:12px; opacity:0.85;">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π; –æ–ø–ª–∞—Ç—ã ‚Äî –Ω–∏–∂–µ. –ï—Å–ª–∏ –≤–∫–ª—é—á–∞–µ—Ç–µ ¬´–∑–∞ –ø–µ—Ä–∏–æ–¥¬ª, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

<div class="payments-header">
    <button class="btn" onclick="addPaymentRow()">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
    <button class="btn" onclick="openPaymentSourcesModal()" title="–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</button>
</div>

<div>
    <table id="paymentTable" class="payments-table">
        <colgroup>
            <col style="width:12%">
            <col style="width:8%">
            <col style="width:9%">
            <col style="width:11%">
            <col style="width:10%">
            <col style="width:20%">
            <col style="width:8%">
            <col style="width:7%">
            <col style="width:7%">
            <col style="width:14%">
            <col style="width:4%">
        </colgroup>

        <thead>
        <tr>
            <th>–ì–æ–¥/–ú–µ—Å—è—Ü</th>
            <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
            <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
            <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
            <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
            <th>–û–ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</th>
            <th>–ø–æ –æ–±—è–∑.</th>
            <th>–ø–æ –ø–µ–Ω–∏</th>
            <th>–í—Å–µ–≥–æ</th>
            <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
            <th>ID</th>
        </tr>
        </thead>
        <tbody id="paymentTableBody"></tbody>
    </table>
</div>

<div class="bottom-nav">
    <a href="index.html" class="back-btn">‚¨Ö –Ω–∞–∑–∞–¥</a>
</div>

<div id="notesModal"
     style="position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.4);display:none;align-items:center;
            justify-content:center;z-index:5000;">
    <div style="width:450px;background:#fff;border:2px solid #000;padding:20px;">
        <h3>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>
        <textarea id="notesText"
                  style="width:100%;height:200px;border:2px solid #000;"></textarea>
        <div style="margin-top:15px;display:flex;justify-content:space-between;">
            <button onclick="saveNotes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeNotesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- ===== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ ===== -->
<div id="changeResponsibleModal">
    <div class="change-resp-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 style="margin:0;">–°–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</h3>
            <div class="readonly-hint" style="text-align:right;">
                –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ —É —Ç–µ–∫—É—â–µ–≥–æ<br>–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —É –Ω–æ–≤–æ–≥–æ
            </div>
        </div>

        <div id="cr_info" class="muted" style="margin-top:8px;"></div>

        <label>–ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç)</label>
        <select id="cr_newAbonent"></select>

        <label>–î–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏ / –Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</label>
        <input id="cr_date" type="date">

        <div class="change-resp-actions">
            <button onclick="applyChangeResponsible()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button onclick="closeChangeResponsibleModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- ===== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç–∞ ===== -->
<div id="abonentEditModal">
    <div class="abonent-edit-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 style="margin:0;">–ò–∑–º–µ–Ω–∏—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–∞</h3>
            <div class="readonly-hint">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID, –∞–¥—Ä–µ—Å –∏ —Ä–µ–≥. ‚Ññ –∫–≤ –º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è</div>
        </div>

        <div class="abonent-edit-grid">
            <div>
                <label>–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</label>
                <input id="ae_ls" type="text" inputmode="numeric">
            </div>
            <div>
                <label>–†–µ–≥. ‚Ññ –∫–≤</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_regnum" type="text" disabled>
            </div>

            <div>
                <label>–§–∞–º–∏–ª–∏—è</label>
                <input id="ae_last" type="text">
            </div>
            <div>
                <label>–ò–º—è</label>
                <input id="ae_first" type="text">
            </div>

            <div class="full">
                <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
                <input id="ae_mid" type="text">
            </div>

            <div>
                <label>–ì–æ—Ä–æ–¥</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_city" type="text" disabled>
            </div>
            <div>
                <label>–£–ª–∏—Ü–∞</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_street" type="text" disabled>
            </div>

            <div>
                <label>–î–æ–º</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_house" type="text" disabled>
            </div>
            <div>
                <label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
                <!-- ‚úÖ –ù–ê–í–°–ï–ì–î–ê -->
                <input id="ae_flat" type="text" disabled>
            </div>

            <div>
                <label>–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)</label>
                <input id="ae_square" type="number" step="0.1">
            </div>
            <div>
                <label>–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                <input id="ae_rooms" type="text" placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä: "–¥–≤—É—Ö –∫–æ–º–Ω–∞—Ç"'>
            </div>

            <div>
                <label>–ü—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</label>
                <input id="ae_share" type="text" placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä: "1/1"'>
            </div>
            <div>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input id="ae_phone" type="text">
            </div>

            <div class="full">
                <label>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</label>
                <input id="ae_uid" type="text" disabled>
            </div>
        </div>

        <div class="abonent-edit-actions">
            <button type="button" onclick="saveAbonentEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button type="button" onclick="closeAbonentEdit()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
function getAbonentIdFromURL() {
    const params = new URLSearchParams(window.location.search || "");
    const uid = String(params.get("uid") || "").trim();
    const fromUrl = String(params.get("abonent") || "").trim();

    // 1) –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –ø–æ uid ‚Äî –Ω–∞–π–¥—ë–º –õ–° (—Ç–µ–∫—É—â–∏–π –∫–ª—é—á) –ø–æ uid
    if (uid) {
        const db = window.AbonentsDB?.abonents || {};
        for (const id of Object.keys(db)) {
            if (String(db[id]?.uid || "").trim() === uid) return id;
        }
    }

    // 2) –∏–Ω–∞—á–µ ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–ø–æ –õ–°)
    if (fromUrl) return fromUrl;

    const db = window.AbonentsDB?.abonents || {};
    const first = Object.keys(db)[0];
    return first || "27";
}

function getDb() {
    return window.AbonentsDB?.abonents || {};
}

function getPremisesDb(){
    return window.AbonentsDB?.premises || {};
}

function getLinks(){
    return Array.isArray(window.AbonentsDB?.links) ? window.AbonentsDB.links : [];
}

function getPremiseForAbonent(abonentId, abonentObj){
    const a = abonentObj || null;
    const regnum = String(a?.premiseRegnum || a?.regnum || "").trim();
    if (!regnum) return { regnum: "", p: null };
    const p = getPremisesDb()[regnum] || null;
    return { regnum, p };
}

function getActiveLinkForAbonent(abonentId, regnum){
    const id = String(abonentId);
    const r = String(regnum || "").trim();
    const links = getLinks().filter(l => String(l?.abonentId) === id && String(l?.regnum || "").trim() === r);
    if (!links.length) return null;
    // –∞–∫—Ç–∏–≤–Ω–∞—è = –±–µ–∑ dateTo, –∏–Ω–∞—á–µ –±–µ—Ä—ë–º —Å–∞–º—É—é –ø–æ–∑–¥–Ω—é—é
    const active = links.find(l => !String(l?.dateTo || "").trim());
    if (active) return active;
    return links.slice().sort((a,b) => String(b?.dateTo||"").localeCompare(String(a?.dateTo||"")))[0];
}


function getActiveLinkForPremise(regnum){
    const r = String(regnum || '').trim();
    if (!r) return null;
    const links = getLinks().filter(l => String(l?.regnum || '').trim() === r);
    if (!links.length) return null;
    const active = links.find(l => !String(l?.dateTo || '').trim());
    if (active) return active;
    return links.slice().sort((a,b) => String(b?.dateTo||"").localeCompare(String(a?.dateTo||"")))[0];
}


function getCurrentAbonent() {
    const id = String(getAbonentIdFromURL());
    const db = getDb();
    return { id, a: db[id] || null };
}

function splitFio(fio) {
    const parts = String(fio || "").trim().split(/\s+/).filter(Boolean);
    return {
        last: parts[0] || "",
        first: parts[1] || "",
        mid: parts.slice(2).join(" ") || ""
    };
}

function joinFio(last, first, mid) {
    return [last, first, mid].map(x => String(x || "").trim()).filter(Boolean).join(" ");
}


async function copyUidFromCard(){
    const { a } = getCurrentAbonent();
    const uid = String(a?.uid || "").trim();
    if (!uid) return;

    try{
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(uid);
            alert("UID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
            return;
        }
    }catch(e){}

    const ta = document.createElement("textarea");
    ta.value = uid;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand("copy"); alert("UID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"); } catch(e){}
    document.body.removeChild(ta);
}

function fillAbonentCard() {
    const { id, a } = getCurrentAbonent();
    if (!a) return;

    const { regnum, p } = getPremiseForAbonent(id, a);
    const premise = p || {};
    const link = regnum ? getActiveLinkForAbonent(id, regnum) : null;

    const fioParts = splitFio(a.fio);

    document.getElementById("abonentTitle").innerHTML =
        '–û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ&nbsp;&nbsp;' + (a.fio || "") +
        ' <span class="edit-link" onclick="openAbonentEdit()">–∏–∑–º–µ–Ω–∏—Ç—å</span>';

    const tbody = document.getElementById("abonentInfoBody");
    tbody.innerHTML = `
      <tr>
        <td>${id}</td>
        <td>${regnum || a.regnum || ""}</td>
        <td>${fioParts.last}</td>
        <td>${fioParts.first}</td>
        <td>${fioParts.mid}</td>
        <td>${(premise.square ?? a.square) ?? ""}</td>
        <td>${a.share ?? ""}</td>
        <td>${a.rooms ?? ""}</td>
        <td>${premise.city ?? a.city ?? ""}</td>
        <td>${premise.street ?? a.street ?? ""}</td>
        <td>${premise.house ?? a.house ?? ""}</td>
        <td>${premise.flat ?? a.flat ?? ""}</td>
        <td class="uid-click" onclick="copyUidFromCard()" title="–ù–∞–∂–º–∏ ‚Äî —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å UID">${a.uid ?? ""}</td>
        <td>${a.phone ?? ""}</td>
      </tr>
    `;

    // ===== –ó–∞–ø–æ–ª–Ω—è–µ–º –±–ª–æ–∫ "–ö–≤–∞—Ä—Ç–∏—Ä–∞ / –ü—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª—å" =====
    const addr = [premise.city ?? a.city, premise.street ?? a.street, premise.house ?? a.house, premise.flat ?? a.flat]
        .map(x => String(x || '').trim()).filter(Boolean).join(', ');

    const setText = (id, val) => {
        const el = document.getElementById(id);
        if (!el) return;
        const v = String(val || '').trim();
        el.textContent = v ? v : '‚Äî';
    };

    setText('premiseRegnum', regnum || a.regnum || '');
    setText('premiseAddress', addr);
    setText('premiseSquare', (premise.square ?? a.square) ?? '');
    setText('premiseCreatedAt', premise.createdAt || '');

    const activePremiseLink = regnum ? getActiveLinkForPremise(regnum) : null;
    const activeAbId = String(activePremiseLink?.abonentId || '').trim();
    const activeAb = activeAbId ? (getDb()[activeAbId] || null) : null;
    const activeName = String(activeAb?.fio || '').trim();

    if (activeAbId) {
        setText('premiseResponsible', activeName ? `${activeAbId} ‚Äî ${activeName}` : activeAbId);
        const df = String(activePremiseLink?.dateFrom || '').trim();
        const dt = String(activePremiseLink?.dateTo || '').trim();

        const periodHtml = (df || dt)
            ? `${df || '‚Äî'} ‚Äî ${dt ? `<span style="color:#c00;font-weight:700;">${dt}</span>` : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}`
            : '‚Äî';
        const pp = document.getElementById('premisePeriod');
        if (pp) pp.innerHTML = periodHtml;

        // –ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞ –ø–æ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ
        const myLink = regnum ? getActiveLinkForAbonent(id, regnum) : null;
        const mdf = String(myLink?.dateFrom || '').trim();
        const mdt = String(myLink?.dateTo || '').trim();
        const myHtml = (mdf || mdt)
            ? `${mdf || '‚Äî'} ‚Äî ${mdt ? `<span style="color:#c00;font-weight:700;">${mdt}</span>` : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}`
            : '‚Äî';
        const mp = document.getElementById('premiseMyPeriod');
        if (mp) mp.innerHTML = myHtml;
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤—è–∑–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞ –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        setText('premiseResponsible', (a.fio ? `${id} ‚Äî ${a.fio}` : id));
        const df = String(link?.dateFrom || '').trim();
        const dt = String(link?.dateTo || '').trim();

        const periodHtml = (df || dt)
            ? `${df || '‚Äî'} ‚Äî ${dt ? `<span style="color:#c00;font-weight:700;">${dt}</span>` : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}`
            : '‚Äî';
        const pp = document.getElementById('premisePeriod');
        if (pp) pp.innerHTML = periodHtml;

        // –ü–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞ –ø–æ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ
        const myLink = regnum ? getActiveLinkForAbonent(id, regnum) : null;
        const mdf = String(myLink?.dateFrom || '').trim();
        const mdt = String(myLink?.dateTo || '').trim();
        const myHtml = (mdf || mdt)
            ? `${mdf || '‚Äî'} ‚Äî ${mdt ? `<span style="color:#c00;font-weight:700;">${mdt}</span>` : '–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è'}`
            : '‚Äî';
        const mp = document.getElementById('premiseMyPeriod');
        if (mp) mp.innerHTML = myHtml;
    

    // ‚úÖ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ
    try { renderResponsibilityHistory(regnum || a.regnum || ''); } catch(e) {}
}
}
	// üî¥ CRITICAL: –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ + –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–ø—É—Å–∫–æ–≤
	// –ù–µ –º–µ–Ω—è–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–∞—Ä—Ç–æ—á–∫–∏. –î–µ–ª–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ:
	// –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç –¥–≤–∏–∂–æ–∫ –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–π, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
	// –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —è–Ω–≤–∞—Ä—å 2026), –µ—Å–ª–∏ –∏—Ö —É–¥–∞–ª–∏–ª–∏ —Å–ª—É—á–∞–π–Ω–æ.
	function __runAutoAccrualRepairOnce(){
	    try {
	        const id = getAbonentIdFromURL();
	        if (!id) return;
	        const gk = 'jkh_autoaccrual_repair_once_v1:' + String(id);
	        if (sessionStorage.getItem(gk) === '1') return;
	        sessionStorage.setItem(gk, '1');

	        if (!window.JKHAutoAccrual || typeof window.JKHAutoAccrual.recalcForAbonent !== 'function') return;
	        const res = window.JKHAutoAccrual.recalcForAbonent(id);
	        // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–¥–æ–±–∞–≤–∏–ª–∏—Å—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è) ‚Äî –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É
	        if (res && res.ok && res.changed) {
	            try { if (window.__loadPaymentTable) window.__loadPaymentTable(); } catch(e) {}
	        }
	    } catch(e) {
	        try { console.warn('[autoaccrual] repairOnce error', e); } catch(_){ }
	    }
	}

	document.addEventListener("DOMContentLoaded", () => {
	    // 1) –∑–∞–ø–æ–ª–Ω–∏—Ç—å —à–∞–ø–∫—É/–¥–∞–Ω–Ω—ã–µ –∞–±–æ–Ω–µ–Ω—Ç–∞
	    fillAbonentCard();
	    // 2) –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –º–µ—Å—è—Ü—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —è–Ω–≤–∞—Ä—å)
	    __runAutoAccrualRepairOnce();
	    // 3) –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É (–µ—Å–ª–∏ –¥–≤–∏–∂–æ–∫ –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–ª —Å–∞–º)
	    try { if (window.__loadPaymentTable) window.__loadPaymentTable(); } catch(e) {}
	});
function renderResponsibilityHistory(regnum){
  const body = document.getElementById('respHistoryBody');
  if (!body) return;
  body.innerHTML = '';

  const r = String(regnum || '').trim();
  if (!r){
    body.innerHTML = `<tr><td colspan="5" style="border:2px solid #000; padding:6px;">–ù–µ—Ç regnum ‚Äî –∏—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</td></tr>`;
    return;
  }

  const links = getLinks()
    .filter(l => String(l?.regnum || '').trim() === r)
    .slice()
    .sort((a,b) => String(b?.dateFrom||'').localeCompare(String(a?.dateFrom||'')));

  if (!links.length){
    body.innerHTML = `<tr><td colspan="5" style="border:2px solid #000; padding:6px;">–°–≤—è–∑–µ–π (–∏—Å—Ç–æ—Ä–∏–∏) –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>`;
    return;
  }

  const db = getDb();
  links.forEach(l => {
    const aid = String(l?.abonentId || '').trim();
    const fio = String(db[aid]?.fio || '').trim();
    const df = String(l?.dateFrom || '').trim();
    const dt = String(l?.dateTo || '').trim();
    const active = !dt;
    const period = `${df || '‚Äî'} ‚Äî ${dt ? dt : '–ø–æ –Ω–∞—Å—Ç. –≤—Ä–µ–º—è'}`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700;' : ''}">${period}</td>
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700;' : ''}">${aid}</td>
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700;' : ''}">${fio || '‚Äî'}</td>
      <td style="border:2px solid #000; padding:6px; ${active ? 'font-weight:700; color:#0a0;' : ''}">
        ${active ? '—Ç–µ–∫—É—â–∏–π' : '–∑–∞–∫—Ä—ã—Ç'}
      </td>
      <td style="border:2px solid #000; padding:6px;">
        <a href="abonent_card.html?abonent=${encodeURIComponent(aid)}" style="text-decoration:underline;">–æ—Ç–∫—Ä—ã—Ç—å</a>
      </td>
    `;
    body.appendChild(tr);
  });
}

function openResponsibilityReport(){
  const { id, a } = getCurrentAbonent();
  if (!a) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  const { regnum } = getPremiseForAbonent(id, a);
  const r = String(regnum || '').trim();
  if (!r) { alert('–ù–µ—Ç regnum ‚Äî –æ—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
  window.location.href = 'responsibility_report.html?regnum=' + encodeURIComponent(r);
}


// ===== –°–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (—Å–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞) =====
function openChangeResponsibleModal() {
    const { id, a } = getCurrentAbonent();
    if (!a) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    const { regnum, p } = getPremiseForAbonent(id, a);
    if (!regnum) {
        alert('–£ –∞–±–æ–Ω–µ–Ω—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω —Ä–µ–≥. ‚Ññ –∫–≤ ‚Äî —Å–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.');
        return;
    }

    const premise = p || {};
    const db = getDb();
    const links = Array.isArray(window.AbonentsDB?.links) ? window.AbonentsDB.links : [];

    const active = links.find(l => String(l.regnum) === String(regnum) && !String(l.dateTo || '').trim());
    const activeId = active ? String(active.abonentId) : '';

    // –ò–Ω—Ñ–æ
    const addr = [premise.city, premise.street, premise.house, premise.flat].filter(Boolean).join(', ');
    const infoEl = document.getElementById('cr_info');
    if (infoEl) {
        const curName = activeId && db[activeId] ? (db[activeId].fio || '') : (a.fio || '');
        const curDf = String(active?.dateFrom || '').trim();
        infoEl.innerHTML = `–û–±—ä–µ–∫—Ç: <b>${regnum}</b>${addr ? ' ‚Äî ' + addr : ''}<br>` +
            `–¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <b>${activeId || id}</b> ${curName ? '‚Äî ' + curName : ''}` +
            (curDf ? ` (—Å <b>${curDf}</b>)` : '');
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤
    const sel = document.getElementById('cr_newAbonent');
    sel.innerHTML = '';

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∏—Å–ª—É (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
    const ids = Object.keys(db).sort((x, y) => {
        const nx = Number(x), ny = Number(y);
        if (!Number.isNaN(nx) && !Number.isNaN(ny)) return nx - ny;
        return String(x).localeCompare(String(y), 'ru');
    });

    ids.forEach(k => {
        if (String(k) === String(id)) return; // –∏—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ
        const fio = String(db[k]?.fio || '').trim();
        const opt = document.createElement('option');
        opt.value = String(k);
        opt.textContent = fio ? `${k} ‚Äî ${fio}` : String(k);
        sel.appendChild(opt);
    });

    // –î–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const dateInput = document.getElementById('cr_date');
    if (dateInput && !dateInput.value) dateInput.value = `${yyyy}-${mm}-${dd}`;

    document.getElementById('changeResponsibleModal').style.display = 'flex';
}

function closeChangeResponsibleModal() {
    const m = document.getElementById('changeResponsibleModal');
    if (m) m.style.display = 'none';
}

function applyChangeResponsible() {
    const { id, a } = getCurrentAbonent();
    if (!a) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    const { regnum, p } = getPremiseForAbonent(id, a);
    if (!regnum) { alert('–ù–µ—Ç —Ä–µ–≥. ‚Ññ –∫–≤'); return; }

    const newId = String(document.getElementById('cr_newAbonent')?.value || '').trim();
    const dateFrom = String(document.getElementById('cr_date')?.value || '').trim();

    if (!newId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ'); return; }
    if (!dateFrom) { alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø–µ—Ä–µ–¥–∞—á–∏'); return; }
    if (String(newId) === String(id)) { alert('–ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º'); return; }

    const db = getDb();
    if (!db[String(newId)]) { alert('–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: ' + newId); return; }

    if (!window.AbonentsDB) window.AbonentsDB = {};
    if (!window.AbonentsDB.links) window.AbonentsDB.links = [];

    const links = window.AbonentsDB.links;

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—ã)
    const otherActive = links.find(l => String(l.abonentId) === String(newId)
        && !String(l.dateTo || '').trim()
        && String(l.regnum) !== String(regnum));
    if (otherActive) {
        alert(`–£ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞: ${otherActive.regnum}.\n` +
              `–°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–æ–π—Ç–µ –µ—ë –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞.`);
        return;
    }

    // 0) —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–≤—è–∑–∏ –ø–æ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ
    // (–∏–Ω–æ–≥–¥–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤/–æ—à–∏–±–æ–∫ –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è >1 –∞–∫—Ç–∏–≤–Ω–æ–π ‚Äî –º—ã —ç—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º)
    const activeList = links.filter(l =>
        String(l.regnum) === String(regnum) && !String(l.dateTo || '').trim()
    );

    const currentActive = activeList.length === 1 ? activeList[0] : null;
    const currentActiveId = currentActive ? String(currentActive.abonentId) : "";

    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–æ—Ç –∂–µ, –∫—Ç–æ —É–∂–µ —Ç–µ–∫—É—â–∏–π (–∏ –Ω–µ—Ç –¥—É–±–ª–µ–π) ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
    if (currentActiveId && String(currentActiveId) === String(newId)) {
        alert('–≠—Ç–æ—Ç –∞–±–æ–Ω–µ–Ω—Ç —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ –¥–∞–Ω–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ.');
        return;
    }

    // 1) –∑–∞–∫—Ä—ã–≤–∞–µ–º –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–≤—è–∑–∏ –ø–æ —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ (–≥–∞—Ä–∞–Ω—Ç–∏—è: –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–∏–æ–¥)
    activeList.forEach(l => {
        l.dateTo = dateFrom;

        // –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ä–∞—Å—á—ë—Ç —É —Å—Ç–∞—Ä–æ–≥–æ –õ–°
        const oldAb = db[String(l.abonentId)];
        if (oldAb) oldAb.calcEndDate = dateFrom;
    });

    // 2) —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Å–≤—è–∑—å
    links.push({
        abonentId: String(newId),
        regnum: String(regnum),
        dateFrom: String(dateFrom),
        dateTo: ""
    });

    // 2–∞) —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞ —É –Ω–æ–≤–æ–≥–æ –õ–° (—á—Ç–æ–±—ã –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/–¥–æ–ª–≥ –Ω–µ "–ª–µ–∑–ª–∏" –≤ —á—É–∂–æ–π –ø–µ—Ä–∏–æ–¥)
    const newAb = db[String(newId)];
    if (newAb) {
        newAb.calcStartDate = dateFrom;
        newAb.calcEndDate = "";
    }

    // 3) –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–ø–æ–∫–∞ —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ UI)
    const premise = p || (window.AbonentsDB.premises ? window.AbonentsDB.premises[String(regnum)] : null) || {};
    const na = db[String(newId)];
    if (na) {
        na.regnum = String(regnum);
        if (premise.city)   na.city = premise.city;
        if (premise.street) na.street = premise.street;
        if (premise.house)  na.house = premise.house;
        if (premise.flat)   na.flat = premise.flat;
        if (premise.square !== undefined && premise.square !== null && premise.square !== "") na.square = premise.square;
    }

    saveAbonentsDB();

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
    window.location.href = 'abonent_card.html?abonent=' + encodeURIComponent(String(newId));
}

function openAbonentEdit() {
    const { id, a } = getCurrentAbonent();
    if (!a) { alert("–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

    const { regnum, p } = getPremiseForAbonent(id, a);
    const premise = p || {};

    const fioParts = splitFio(a.fio);

    document.getElementById("ae_ls").value = id;

    // ‚úÖ –ù–ê–í–°–ï–ì–î–ê (—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑)
    document.getElementById("ae_regnum").value = regnum || a.regnum || "";
    document.getElementById("ae_city").value   = premise.city || a.city || "";
    document.getElementById("ae_street").value = premise.street || a.street || "";
    document.getElementById("ae_house").value  = premise.house || a.house || "";
    document.getElementById("ae_flat").value   = premise.flat || a.flat || "";

    document.getElementById("ae_last").value  = fioParts.last;
    document.getElementById("ae_first").value = fioParts.first;
    document.getElementById("ae_mid").value   = fioParts.mid;

    document.getElementById("ae_square").value = ((premise.square ?? a.square) ?? "");
    document.getElementById("ae_rooms").value  = a.rooms || "";
    document.getElementById("ae_share").value  = a.share || "";
    document.getElementById("ae_phone").value  = a.phone || "";

    document.getElementById("ae_uid").value = a.uid || "";

    document.getElementById("abonentEditModal").style.display = "flex";
}

function closeAbonentEdit() {
    document.getElementById("abonentEditModal").style.display = "none";
}

function migrateLocalKeys(oldId, newId) {
    const pairs = [
        ["note_", "note_"],
        ["moratorium_", "moratorium_"],
        ["calc_period_", "calc_period_"],
        ["calc_period_active_", "calc_period_active_"],
        ["exclude_periods_", "exclude_periods_"]
    ];

    pairs.forEach(([pOld, pNew]) => {
        const oldKey = pOld + oldId;
        const newKey = pNew + newId;
        const val = localStorage.getItem(oldKey);
        if (val !== null && localStorage.getItem(newKey) === null) {
            localStorage.setItem(newKey, val);
        }
        if (val !== null) localStorage.removeItem(oldKey);
    });
}

function saveAbonentEdit() {
    const { id: oldId, a } = getCurrentAbonent();
    if (!a) { alert("–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"); return; }

    const db = getDb();

    const newIdRaw = document.getElementById("ae_ls").value.trim();
    const newId = newIdRaw === "" ? oldId : newIdRaw;

    const last  = document.getElementById("ae_last").value.trim();
    const first = document.getElementById("ae_first").value.trim();
    const mid   = document.getElementById("ae_mid").value.trim();

    const fio = joinFio(last, first, mid);

    if (!newId) { alert("–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"); return; }
    if (!fio) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è (–º–∏–Ω–∏–º—É–º)"); return; }

    const isIdChanged = String(newId) !== String(oldId);
    if (isIdChanged && db[String(newId)]) {
        alert("–¢–∞–∫–æ–π –ª–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: " + newId);
        return;
    }

    // ‚úÖ –ù–ê–í–°–ï–ì–î–ê: regnum + –∞–¥—Ä–µ—Å –ù–ï –¢–†–û–ì–ê–ï–ú
    // a.regnum = ...
    // a.city/a.street/a.house/a.flat = ...

    // –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –§–ò–û / –ø–ª–æ—â–∞–¥—å / –∫–æ–º–Ω–∞—Ç—ã / –¥–æ–ª—é / —Ç–µ–ª–µ—Ñ–æ–Ω
    a.fio    = fio;

    const sq = document.getElementById("ae_square").value;
    a.square = (sq === "" ? "" : Number(sq));

    a.rooms  = document.getElementById("ae_rooms").value.trim();
    a.share  = document.getElementById("ae_share").value.trim();
    a.phone  = document.getElementById("ae_phone").value.trim();

    if (isIdChanged) {
        db[String(newId)] = a;
        delete db[String(oldId)];
        migrateLocalKeys(String(oldId), String(newId));

        const url = new URL(window.location.href);
        url.searchParams.set("abonent", String(newId));
        window.history.replaceState({}, "", url.toString());
    }

    if (window.saveAbonentsDB) window.saveAbonentsDB();

    closeAbonentEdit();
    fillAbonentCard();
	
    loadMoratoriumUI();

    if (window.__loadPaymentTable) window.__loadPaymentTable();

    alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
	renderResponsibilityHistory(regnum);

}

function moratoriumKey(id){ return "moratorium_" + id; }

function loadMoratoriumUI(){
    const id = getAbonentIdFromURL();
    const el = document.getElementById("moratoriumToggle");
    if (!el) return;
    el.checked = localStorage.getItem(moratoriumKey(id)) === "1";
}
function bindMoratoriumUI(){
    const id = getAbonentIdFromURL();
    const el = document.getElementById("moratoriumToggle");
    if (!el) return;
    el.addEventListener("change", () => {
        localStorage.setItem(moratoriumKey(id), el.checked ? "1" : "0");
        if (window.__loadPaymentTable) window.__loadPaymentTable();
    });
}
document.addEventListener("DOMContentLoaded", () => {
    loadMoratoriumUI();
    bindMoratoriumUI();
});

function openNotesModal() {
    const id = getAbonentIdFromURL();
    const note = localStorage.getItem("note_" + id) || "";
    document.getElementById("notesText").value = note;
    document.getElementById("notesModal").style.display = "flex";
}
function closeNotesModal() {
    document.getElementById("notesModal").style.display = "none";
}
function saveNotes() {
    const id = getAbonentIdFromURL();
    const txt = document.getElementById("notesText").value.trim();
    localStorage.setItem("note_" + id, txt);
    closeNotesModal();
    alert("–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

function calcPeriodKey(id){ return "calc_period_" + id; }
function calcPeriodActiveKey(id){ return "calc_period_active_" + id; }

function loadCalcPeriodUI(){
    const id = getAbonentIdFromURL();
    const fromEl = document.getElementById("calcFrom");
    const toEl   = document.getElementById("calcTo");
    if (!fromEl || !toEl) return;

    try {
        const raw = localStorage.getItem(calcPeriodKey(id));
        if (raw) {
            const obj = JSON.parse(raw);
            fromEl.value = obj.from || "";
            toEl.value   = obj.to || "";
        } else {
            fromEl.value = "";
            toEl.value   = "";
        }
    } catch {
        fromEl.value = "";
        toEl.value   = "";
    }
}

function saveCalcPeriod(from, to){
    const id = getAbonentIdFromURL();
    localStorage.setItem(calcPeriodKey(id), JSON.stringify({from: from || "", to: to || ""}));
}

function setCalcPeriodActive(active){
    const id = getAbonentIdFromURL();
    localStorage.setItem(calcPeriodActiveKey(id), active ? "1" : "0");
}

function isValidPeriod(from, to){
    if (!from || !to) return false;
    try {
        const a = new Date(from);
        const b = new Date(to);
        return a.toString() !== "Invalid Date" && b.toString() !== "Invalid Date" && a <= b;
    } catch { return false; }
}

function bindCalcButtons(){
    const runBtn = document.getElementById("calcRunBtn");
    const repBtn = document.getElementById("calcReportsBtn");
    const resetBtn = document.getElementById("calcResetBtn");
    const fromEl = document.getElementById("calcFrom");
    const toEl   = document.getElementById("calcTo");
    if (!runBtn || !repBtn || !resetBtn || !fromEl || !toEl) return;

    runBtn.addEventListener("click", () => {
        const from = fromEl.value;
        const to   = toEl.value;

        if (!isValidPeriod(from, to)) {
            saveCalcPeriod("", "");
            setCalcPeriodActive(false);
            if (window.__loadPaymentTable) window.__loadPaymentTable();
            return;
        }

        saveCalcPeriod(from, to);
        setCalcPeriodActive(true);

        if (window.__loadPaymentTable) window.__loadPaymentTable();
    });

    resetBtn.addEventListener("click", () => {
        saveCalcPeriod("", "");
        setCalcPeriodActive(false);
        fromEl.value = "";
        toEl.value = "";
        if (window.__loadPaymentTable) window.__loadPaymentTable();
    });

    repBtn.addEventListener("click", () => {
        const id = getAbonentIdFromURL();
        location.href = "reports.html?abonent=" + encodeURIComponent(id);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    loadCalcPeriodUI();
    bindCalcButtons();
});

document.addEventListener("click", (e) => {
    const m = document.getElementById("abonentEditModal");
    if (!m) return;
    if (m.style.display === "flex" && e.target === m) closeAbonentEdit();
});
</script>

<script>closeLayout();</script>

<!-- –ú–æ–¥–∞–ª–∫–∞: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
<div id="sourcesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:720px; max-width:95vw; border:2px solid #000; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:700;">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
      <button class="btn" type="button" onclick="closePaymentSourcesModal()">‚úñ</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <input id="sourceNewInput" type="text" placeholder="–ù–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–Ω–∫, –ü–æ—á—Ç–∞, –û–Ω–ª–∞–π–Ω)" style="flex:1; padding:8px; border:2px solid #000;">
      <button class="btn" type="button" onclick="addPaymentSourceFromModal()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div style="margin-top:10px; font-size:12px; opacity:.85;">
      –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Ç–µ–∫—É—â–µ–≥–æ –∞–±–æ–Ω–µ–Ω—Ç–∞. –£–¥–∞–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Äî –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ –∑–∞–º–µ–Ω–∞.
    </div>

    <div id="sourcesList" style="margin-top:10px; max-height:45vh; overflow:auto; border-top:2px solid #000; padding-top:8px;"></div>

    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn" type="button" onclick="closePaymentSourcesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

</body>
</html>
