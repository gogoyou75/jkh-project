[file name]: import_xls.html
[file content begin]
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
    <script src="critical_guard.js" defer></script>
  <title>–ò–º–ø–æ—Ä—Ç –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Excel) ‚Äî FIXED Excel-–¥–∞—Ç—ã</title>

  <link rel="stylesheet" href="style.css">

  <!-- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ–¥–∫–ª—é—á–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –î–û layout.js -->
  <script src="data.js"></script>
  <script src="layout.js"></script>

  <!-- ‚úÖ –õ–û–ö–ê–õ–¨–ù–û: –ø–æ–ª–æ–∂–∏ xlsx.full.min.js —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º -->
  <script src="xlsx.full.min.js"></script>

  <!-- ‚úÖ Variant A: –¥–≤–∏–∂–æ–∫ –∞–≤—Ç–æ-–Ω–∞—á–∏—Å–ª–µ–Ω–∏–π (–±–µ–∑ UI –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
  <script src="autoaccrual_engine.js"></script>

  <style>
    .import-page-title{ font-size:22px; margin:10px 0 15px; }
    .import-box{ border:2px solid #000; padding:15px; background:#fafafa; box-sizing:border-box; }
    .import-box h3{ margin:0 0 10px; font-size:16px; }
    .import-btn{ border:2px solid #000; padding:6px 14px; background:#e5e5e5; cursor:pointer; font-size:14px; margin-top:8px; }
    .import-btn:disabled{ opacity:0.5; cursor:default; }
    .import-preview-container{ margin-top:10px; max-height:360px; overflow:auto; background:#fff; }
    table.preview{ width:100%; border-collapse:collapse; font-size:12px; }
    table.preview th, table.preview td{ border:1px solid #000; padding:4px 6px; vertical-align:top; }
    table.preview th{ background:#f2f2f2; position:sticky; top:0; z-index:2; }
    .row-ok{ background:#e6ffe6; }
    .row-new{ background:#e6f0ff; }
    .row-warn{ background:#fff7d6; }
    .row-error{ background:#ffe6e6; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ font-size:11px; opacity:0.9; }
    .import-summary{ margin-top:8px; font-size:12px; }

    /* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ "—Ç—Ä–æ–≥–∞–ª–∏" –≤—Ä—É—á–Ω—É—é */
    .row-touched{
      outline: 2px dashed #000;
      outline-offset: -2px;
    }

    .import-actions-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }
    .file-status{
      margin-top:6px;
      font-size:12px;
      padding:6px 8px;
      border:1px solid #000;
      background:#fff;
    }

    .warn{
      border:2px solid #000;
      padding:8px 10px;
      background:#fff6e5;
      font-size:13px;
    }
  </style>
</head>
<body>
<script>renderLayout();</script>

<div class="content">
  <h2 class="import-page-title">–ò–º–ø–æ—Ä—Ç –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel</h2>

  <div class="layout-two">

    <!-- –õ–µ–≤—ã–π –±–ª–æ–∫ -->
    <div class="import-box">
      <h3>–®–∞–≥ 1. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö</h3>
      <div class="small">
        –ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>–æ–¥–∏–Ω</b> —Ñ–∞–π–ª: <span class="mono">–®–∞–±–ª–æ–Ω–ù–æ–≤—ã–µ–ø–µ—Ä–≤–∏—á–Ω—ã–µ–¥–∞–Ω–Ω—ã–µ.xlsx</span><br>
        –ö–æ–ª–æ–Ω–∫–∏ —á–∏—Ç–∞—é—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: UID(0), –õ–°(1), –§–ò–û(2-4), –ø–ª–æ—â–∞–¥—å(5), –æ–ø–ª–∞—Ç—ã(6-77).
      </div>

      <div style="margin:10px 0;">
        <input type="file" id="fileInput" accept=".xlsx,.xls">
      </div>

      <button class="import-btn" id="btnPreview">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>

      <div class="small" style="margin-top:10px; line-height:1.35;">
        <b>CRITICAL:</b><br>
        ‚Ä¢ –µ—Å–ª–∏ UID(0) –ø—É—Å—Ç–æ–π/–Ω–µ–ø–æ—Ö–æ–∂ –Ω–∞ <span class="mono">uid_...</span> ‚Äî —Å—Ç—Ä–æ–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –æ–ø–ª–∞—Ç—ã –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é;<br>
        ‚Ä¢ –µ—Å–ª–∏ –≤ –±–∞–∑–µ —É –õ–° —É–∂–µ –µ—Å—Ç—å UID –∏ –æ–Ω –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Excel ‚Äî —Å—Ç—Ä–æ–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è (–∫–æ–Ω—Ñ–ª–∏–∫—Ç);
      </div>
    </div>

    <!-- –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ -->
    <div class="import-box">
      <h3>–®–∞–≥ 2. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>

      <!-- —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–∂–∏–≤—ë—Ç –≤–º–µ—Å—Ç–µ —Å —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º) -->
      <div class="file-status" id="fileStatusHint">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>

      <div class="import-preview-container" id="previewContainer"></div>

      <div class="import-actions-row">
        <button class="import-btn" id="btnConfirm" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–º–ø–æ—Ä—Ç</button>
        <button class="import-btn" id="btnResetPreview" disabled>–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
      </div>

      <div class="import-summary" id="summaryHint"></div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btnPreview = document.getElementById('btnPreview');
  const btnConfirm = document.getElementById('btnConfirm');
  const btnResetPreview = document.getElementById('btnResetPreview');
  const previewContainer = document.getElementById('previewContainer');
  const summaryHint = document.getElementById('summaryHint');
  const fileInput = document.getElementById('fileInput');
  const fileStatusHint = document.getElementById('fileStatusHint');

  // ====== –ß–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞) ======
  const IMPORT_DRAFT_KEY = 'jkh_import_draft_v1';


  // =================== –ó–ê–ö–û–ù –°–ò–°–¢–ï–ú–´: Excel-–¥–∞—Ç—ã (FIXED) ===================
  // CRITICAL: SheetJS —Ç–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ cellDates:false, –ø–æ—ç—Ç–æ–º—É –¥–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç
  // –¢–û–õ–¨–ö–û –∫–∞–∫ —á–∏—Å–ª–∞ (Excel serial). –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.
  //
  // Excel epoch: 1899-12-30 (—Å —É—á—ë—Ç–æ–º –æ—à–∏–±–∫–∏ Excel –Ω–∞ 1900-02-29)
  // Excel —Ö—Ä–∞–Ω–∏—Ç –¥–∞—Ç—ã –∫–∞–∫ –¥–Ω–∏ –æ—Ç —ç—Ç–æ–π –¥–∞—Ç—ã
  //
  // ===================


  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  function setFileStatus(text){
    fileStatusHint.textContent = text || '–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
  }

  function saveImportDraft(model){
    try {
      localStorage.setItem(IMPORT_DRAFT_KEY, JSON.stringify({
        fileName: model?.fileName || '',
        rows: model?.rows || [],
        stats: model?.stats || null,
        touchedExcelRows: Array.from(model?.touchedExcelRows || []),
        savedAt: new Date().toISOString()
      }));
    } catch(e){
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–º–ø–æ—Ä—Ç–∞', e);
    }
  }

  function loadImportDraft(){
    try {
      const raw = localStorage.getItem(IMPORT_DRAFT_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }

  function clearImportDraft(){
    localStorage.removeItem(IMPORT_DRAFT_KEY);
  }

  // ====== –ö–ê–†–¢–ê –ö–û–õ–û–ù–û–ö (–ø–æ–ª–µ 0..77 -> –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ Excel) ======
  // –ò–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ ‚Äî 0-based (–∫–∞–∫ –≤ sheet_to_json(..., {header:1})).
  const FIELD_COL = [
    1, 2, 4, 5, 6, 7,
    18, 19, 20, 21, 22, 23,
    38, 39, 40, 41, 42, 43,
    58, 59, 60, 61, 62, 63,
    78, 79, 80, 81, 82, 83,
    98, 99, 100, 101, 102, 103,
    118, 119, 120, 121, 122, 123,
    138, 139, 140, 141, 142, 143,
    158, 159, 160, 161, 162, 163,
    178, 179, 180, 181, 182, 183,
    198, 199, 200, 201, 202, 203,
    218, 219, 220, 221, 222, 223,
    238, 239, 240, 241, 242, 243
  ];

  const PAY_START = 6;
  const PAY_END = 77;

  function cellByField(rowArr, fieldIndex){
    const col = FIELD_COL[fieldIndex];
    return (col == null) ? '' : (rowArr?.[col]);
  }

  const MONTHS_RU = [
    '—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å',
    '–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'
  ];

  // previewModel —Ö—Ä–∞–Ω–∏—Ç touchedExcelRows (—Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
  let previewModel = null; // { rows, fileName, stats, touchedExcelRows:Set }

  function toStr(v){
    return (v == null) ? '' : String(v).trim();
  }

  function isValidUid(uid){
    const s = toStr(uid);
    return /^uid_[a-z0-9_\-]{6,}$/i.test(s);
  }

  function parseLs(v){
    const s = toStr(v).replace(/\s+/g,'');
    const m = s.match(/^(\d{4})$/);
    return m ? m[1] : '';
  }

  function fioFromRow(r){
    const last = toStr(cellByField(r, 2));
    const first = toStr(cellByField(r, 3));
    const mid = toStr(cellByField(r, 4));
    return [last, first, mid].filter(Boolean).join(' ').trim();
  }

  function parseAmount(v){
    if (v == null) return 0;
    if (typeof v === 'number') return v;
    const s = String(v).replace(/\s+/g,'').replace(',','.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  // =================== CRITICAL: Excel-–¥–∞—Ç—ã —Ç–æ–ª—å–∫–æ –∫–∞–∫ –ö–ê–õ–ï–ù–î–ê–†–ù–ê–Ø –°–¢–†–û–ö–ê ===================
  // –ü—Ä–∏—á–∏–Ω–∞: Date() —Ç–∞—â–∏—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏ –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å —Å–¥–≤–∏–≥ –Ω–∞ —Å—É—Ç–∫–∏.
  // –ü–æ—ç—Ç–æ–º—É –ª—é–±—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞—Ç—ã –ø—Ä–∏–≤–æ–¥–∏–º —Å—Ä–∞–∑—É –∫ ISO-—Å—Ç—Ä–æ–∫–µ 'YYYY-MM-DD'.
  // =========================================================================================

  function assertISODateString(iso, ctx){
    if (iso == null) return;
    if (typeof iso !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(iso)){
      console.error('CRITICAL: –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π ISO YYYY-MM-DD (Date –∑–∞–ø—Ä–µ—â—ë–Ω –¥–ª—è Excel)', { ctx, iso });
    }
  }

  function parseDateAny(v, ctx){
    if (!v) return null;

    // 1) Excel serial (—á–∏—Å–ª–æ)
    if (typeof v === 'number' && v > 20000 && v < 90000) {
      try {
        if (window.XLSX && XLSX.SSF && typeof XLSX.SSF.parse_date_code === 'function') {
          const d = XLSX.SSF.parse_date_code(v);
          if (d && d.y && d.m && d.d) {
            const yyyy = String(d.y).padStart(4,'0');
            const mm = String(d.m).padStart(2,'0');
            const dd = String(d.d).padStart(2,'0');
            const iso = `${yyyy}-${mm}-${dd}`;
            assertISODateString(iso, ctx || { kind:'excel_serial', raw:v });
            return iso;
          }
        }
      } catch (e) {
        console.error('CRITICAL: –æ—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ Excel serial –¥–∞—Ç—ã', { ctx, raw: v, error: String(e && e.message || e) });
      }
      return null;
    }

    // 2) –°—Ç—Ä–æ–∫–∏
    if (typeof v === 'string') {
      const s = v.trim();

      // dd.mm.yyyy
      let m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
      if (m) {
        const iso = `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
        assertISODateString(iso, ctx || { kind:'dmy_string', raw:s });
        return iso;
      }

      // yyyy-mm-dd
      m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (m) {
        const iso = `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
        assertISODateString(iso, ctx || { kind:'iso_string', raw:s });
        return iso;
      }

      return null;
    }

    // 3) Date (–µ—Å–ª–∏ –≥–¥–µ-—Ç–æ —Å–ª—É—á–∞–π–Ω–æ –≤–µ—Ä–Ω—É–ª–∏ Date ‚Äî —ç—Ç–æ —Ä–µ–≥—Ä–µ—Å—Å)
    if (v instanceof Date && !isNaN(v.getTime())) {
      console.error('CRITICAL: –æ–±–Ω–∞—Ä—É–∂–µ–Ω Date-–æ–±—ä–µ–∫—Ç –≤ –∏–º–ø–æ—Ä—Ç–µ Excel. Date –∑–∞–ø—Ä–µ—â—ë–Ω (timezone —Å–¥–≤–∏–≥–∞–µ—Ç —Å—É—Ç–∫–∏).', { ctx, raw: v });
      const yy = v.getFullYear();
      const mm = String(v.getMonth()+1).padStart(2,'0');
      const dd = String(v.getDate()).padStart(2,'0');
      const iso = `${yy}-${mm}-${dd}`;
      assertISODateString(iso, ctx || { kind:'date_object' });
      return iso;
    }

    return null;
  }

  function isoToDMY(iso){
    const s = String(iso||'');
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}.${m[2]}.${m[1]}` : '';
  }



  function r2(n){
    return Math.round((Number(n)||0) * 100) / 100;
  }

  function getPaymentsKey(ls){
    return 'payments_' + String(ls);
  }

  function loadPayments(ls){
    try {
      const raw = localStorage.getItem(getPaymentsKey(ls));
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function savePayments(ls, arr){
    try {
      localStorage.setItem(getPaymentsKey(ls), JSON.stringify(arr));
    } catch (e){
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å payments_'+ls, e);
    }
  }

  function nextPaymentId(arr){
    let maxId = 0;
    for (const r of (arr||[])){
      const id = Number(r?.id) || 0;
      if (id > maxId) maxId = id;
    }
    return maxId + 1;
  }

  function paymentsHasDuplicate(payArr, isoDate, amount, source){
    const a = r2(amount);
    const s = String(source||'').trim();
    return (payArr||[]).some(r => r2(r?.paid) === a && String(r?.paid_date||'') === String(isoDate||'') && String(r?.source||'').trim() === s);
  }

  function debtsHasDuplicate(debtsArr, dmy, amount){
    const a = r2(amount);
    return (debtsArr||[]).some(r => r2(r?.paid) === a && String(r?.payDate||'') === String(dmy||''));
  }

  function detectDataRows(rows){
    const out = [];
    for (let i=0;i<rows.length;i++){
      const r = rows[i] || [];
      const uid = toStr(cellByField(r, 0));
      const ls = parseLs(cellByField(r, 1));
      if (ls || isValidUid(uid)) out.push({ idx: i, row: r });
    }
    return out;
  }

  function computeRowStatus(rowResult){
    const existing = rowResult._existing || null;

    if (rowResult.problems.length){
      rowResult.status = 'error';
      return;
    }

    if (existing) {
      rowResult.status = rowResult.warnings.length ? 'warn' : 'ok';
    } else {
      rowResult.status = rowResult.warnings.length ? 'warn_new' : 'new';
    }
  }

  function recomputeRowAgainstDB(row){
    row.problems = [];
    row.warnings = [];

    const uidOk = isValidUid(row.uid);
    const lsOk = !!row.ls;

    if (!lsOk) row.problems.push('–õ–°(1) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Ü–∏—Ñ—Ä—ã');

    const existing = (row.ls && AbonentsDB && AbonentsDB.abonents) ? (AbonentsDB.abonents[String(row.ls)] || null) : null;
    row._existing = existing;

    // –µ—Å–ª–∏ –≤ –±–∞–∑–µ –ø–æ—è–≤–∏–ª—Å—è UID, –∞ –≤ —Å—Ç—Ä–æ–∫–µ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø–æ–¥—Ç—è–Ω–µ–º
    if (existing && isValidUid(existing.uid) && !uidOk){
      row.uid = String(existing.uid);
    }

    // –ø–æ—Å–ª–µ –ø–æ–¥—Ç—è–∂–∫–∏ ‚Äî —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏–º
    const uidOk2 = isValidUid(row.uid);
    if (!uidOk2) row.problems.push('–ù–µ—Ç UID(0) –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–æ–∂–∏–¥–∞–µ—Ç—Å—è uid_...)');

    if (!row.fio) row.warnings.push('–§–ò–û –ø—É—Å—Ç–æ–µ');

    if (existing){
      const baseUid = toStr(existing.uid);

      if (baseUid && uidOk2 && baseUid !== String(row.uid)){
        row.problems.push('–ö–æ–Ω—Ñ–ª–∏–∫—Ç UID: –≤ –±–∞–∑–µ –¥—Ä—É–≥–æ–π UID –¥–ª—è —ç—Ç–æ–≥–æ –õ–°');
      }
      if (!baseUid && uidOk2){
        row.warnings.push('–í –±–∞–∑–µ –Ω–µ—Ç UID —É —ç—Ç–æ–≥–æ –õ–° ‚Äî –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ UID –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω');
      }

      const baseFio = toStr(existing.fio);
      if (baseFio && row.fio && baseFio !== row.fio){
        row.warnings.push(`–§–ò–û –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (–±–∞–∑–∞: ${baseFio})`);
      }
      const baseSq = Number(existing.square);
      if (Number.isFinite(baseSq) && baseSq>0 && row.square !== '' && r2(baseSq) !== r2(row.square)){
        row.warnings.push(`–ü–ª–æ—â–∞–¥—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (–±–∞–∑–∞: ${r2(baseSq)})`);
      }
    }

    computeRowStatus(row);
    delete row._existing;
  }

  function analyze(rows){
    const candidates = detectDataRows(rows);

    const model = [];
    let ok=0, warn=0, err=0, neu=0;

    for (const c of candidates){
      const i = c.idx;
      const r = c.row;

      const uidRaw = toStr(cellByField(r, 0));
      const uidOk = isValidUid(uidRaw);
      const ls = parseLs(cellByField(r, 1));
      const fio = fioFromRow(r);
      const sq = parseAmount(cellByField(r, 5));

      const rowResult = {
        excelRow: i+1,
        uid: uidRaw,
        ls,
        fio,
        square: (Number.isFinite(sq) && sq>0) ? sq : '',
        status: 'neutral',
        problems: [],
        warnings: [],
        payments: []
      };

      if (!ls){
        rowResult.problems.push('–õ–°(1) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Ü–∏—Ñ—Ä—ã');
      }
      if (!uidOk){
        rowResult.problems.push('–ù–µ—Ç UID(0) –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–æ–∂–∏–¥–∞–µ—Ç—Å—è uid_...)');
      }
      if (!fio){
        rowResult.warnings.push('–§–ò–û –ø—É—Å—Ç–æ–µ');
      }

      let existing = null;
      if (ls && AbonentsDB && AbonentsDB.abonents) existing = AbonentsDB.abonents[String(ls)] || null;
      rowResult._existing = existing;

      if (existing){
        const baseUid = toStr(existing.uid);
        if (baseUid && uidOk && baseUid !== uidRaw){
          rowResult.problems.push('–ö–æ–Ω—Ñ–ª–∏–∫—Ç UID: –≤ –±–∞–∑–µ –¥—Ä—É–≥–æ–π UID –¥–ª—è —ç—Ç–æ–≥–æ –õ–°');
        }
        if (!baseUid && uidOk){
          rowResult.warnings.push('–í –±–∞–∑–µ –Ω–µ—Ç UID —É —ç—Ç–æ–≥–æ –õ–° ‚Äî –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ UID –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω');
        }

        const baseFio = toStr(existing.fio);
        if (baseFio && fio && baseFio !== fio){
          rowResult.warnings.push(`–§–ò–û –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (–±–∞–∑–∞: ${baseFio})`);
        }
        const baseSq = Number(existing.square);
        if (Number.isFinite(baseSq) && baseSq>0 && rowResult.square !== '' && r2(baseSq) !== r2(rowResult.square)){
          rowResult.warnings.push(`–ü–ª–æ—â–∞–¥—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (–±–∞–∑–∞: ${r2(baseSq)})`);
        }
      }

      // –ø–ª–∞—Ç–µ–∂–∏
      for (let m=0;m<12;m++){
        const monthName = MONTHS_RU[m];
        const start = PAY_START + m*6;

        for (let p=0;p<3;p++){
          const sumCol = start + p*2;
          const dateCol = sumCol + 1;

          if (sumCol > PAY_END || dateCol > PAY_END) continue;

          const amount = parseAmount(cellByField(r, sumCol));
          const iso = parseDateAny(cellByField(r, dateCol), { excelRow: i+1, ls: ls, month: monthName, payNo: p+1 });

          if (amount > 0 && !iso){
            rowResult.problems.push(`${monthName}: —Å—É–º–º–∞ –µ—Å—Ç—å, –¥–∞—Ç—ã –Ω–µ—Ç (–ø–ª–∞—Ç—ë–∂ #${p+1})`);
            continue;
          }
          if (amount <= 0 && iso){
            continue;
          }
          if (amount > 0 && iso){
            const dmy = isoToDMY(iso);
            rowResult.payments.push({ monthName, iso, dmy, amount, source: `–ü–ª–∞—Ç—ë–∂ ${p+1}` });
          }
        }
      }

      computeRowStatus(rowResult);

      if (rowResult.status === 'error') err++;
      else if (rowResult.status === 'warn' || rowResult.status === 'warn_new') warn++;
      else if (rowResult.status === 'ok') ok++;
      else neu++;

      delete rowResult._existing;

      model.push(rowResult);
    }

    return { model, stats: { ok, warn, err, neu, total: model.length } };
  }

  function statusClass(s){
    if (s === 'ok') return 'row-ok';
    if (s === 'new') return 'row-new';
    if (s === 'warn' || s === 'warn_new') return 'row-warn';
    return 'row-error';
  }

  function statusText(s){
    if (s === 'ok') return 'OK (–∞–±–æ–Ω–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω)';
    if (s === 'new') return '–ù–û–í–´–ô –∞–±–æ–Ω–µ–Ω—Ç (—Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ)';
    if (s === 'warn') return '–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (–∞–±–æ–Ω–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω)';
    if (s === 'warn_new') return '–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (–Ω–æ–≤—ã–π –∞–±–æ–Ω–µ–Ω—Ç)';
    return '–û–®–ò–ë–ö–ê (—Å—Ç—Ä–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)';
  }

  function renderPreview(model, stats){
    if (!model || !model.length){
      previewContainer.innerHTML = '<div class="small">–ù–µ—Ç —Å—Ç—Ä–æ–∫ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</div>';
      btnConfirm.disabled = true;
      btnResetPreview.disabled = !previewModel;
      summaryHint.textContent = '';
      return;
    }

    let html = '';
    const missingUid = model.filter(x => !isValidUid(x.uid||''));
    if (missingUid.length){
      html += `<div class="warn" style="margin-bottom:8px;">–ù–∞–π–¥–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ UID: <b>${missingUid.length}</b>. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–∞" –≤ –Ω—É–∂–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.</div>`;
    }

    html += '<table class="preview">';
    html += '<thead><tr>' +
      '<th>#</th>' +
      '<th>UID(0)</th>' +
      '<th>–õ–°(1)</th>' +
      '<th>–§–ò–û</th>' +
      '<th>–ü–ª–æ—â–∞–¥—å</th>' +
      '<th>–ü–ª–∞—Ç–µ–∂–∏</th>' +
      '<th>–°—Ç–∞—Ç—É—Å / –¥–µ—Ç–∞–ª–∏</th>' +
    '</tr></thead><tbody>';

    const touched = previewModel?.touchedExcelRows || new Set();

    for (const r of model){
      const cls = statusClass(r.status);
      const touchedCls = touched.has(Number(r.excelRow)) ? ' row-touched' : '';
      const payBrief = r.payments.length ? (r.payments.length + ' —à—Ç.') : '‚Äî';
      const details = [];

      if (r.problems.length) details.push('<b>–û—à–∏–±–∫–∏:</b> ' + r.problems.map(x=>escapeHtml(x)).join('; '));
      if (r.warnings.length) details.push('<b>–ü—Ä–µ–¥—É–ø—Ä.:</b> ' + r.warnings.map(x=>escapeHtml(x)).join('; '));

      if (r.payments.length){
        const sample = r.payments.slice(0,3).map(p => `${p.monthName}: ${p.amount} (${p.dmy})`).join('\n');
        details.push('<b>–ü—Ä–∏–º–µ—Ä –ø–ª–∞—Ç–µ–∂–µ–π:</b><br>' + escapeHtml(sample).replace(/\n/g,'<br>'));
      }

      const uidValid = isValidUid(r.uid || '');
      if (!uidValid){
        details.push(` <div style="margin-top:6px;"><button type="button" class="import-btn" data-create-ab="1" data-excelrow="${r.excelRow}">–°–æ–∑–¥–∞—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–∞</button></div> `);
      }

      html += `<tr class="${cls}${touchedCls}">` +
        `<td>${r.excelRow}</td>` +
        `<td class="mono">${escapeHtml(r.uid || '')}</td>` +
        `<td class="mono">${escapeHtml(r.ls || '')}</td>` +
        `<td>${escapeHtml(r.fio || '')}</td>` +
        `<td>${escapeHtml(String(r.square || ''))}</td>` +
        `<td>${escapeHtml(payBrief)}</td>` +
        `<td><div><b>${escapeHtml(statusText(r.status))}</b></div><div class="small">${details.join('<br>')}</div></td>` +
      '</tr>';
    }

    html += '</tbody></table>';
    previewContainer.innerHTML = html;

    bindCreateButtons(model);

    summaryHint.textContent =
      `–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: ${stats.total}. OK: ${stats.ok}. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${stats.warn}. –ù–æ–≤—ã–µ: ${stats.neu}. –û—à–∏–±–∫–∏: ${stats.err}.`;

    btnConfirm.disabled = model.every(r => r.status === 'error');
    btnResetPreview.disabled = false;
  }

  function splitFioParts(fio){
    const s = String(fio||'').trim().replace(/\s+/g,' ');
    if (!s) return { last:'', first:'', mid:'' };
    const parts = s.split(' ');
    return {
      last: parts[0] || '',
      first: parts[1] || '',
      mid: parts.slice(2).join(' ') || ''
    };
  }

  function touchRow(excelRow){
    if (!previewModel) return;
    if (!previewModel.touchedExcelRows) previewModel.touchedExcelRows = new Set();
    previewModel.touchedExcelRows.add(Number(excelRow));
    saveImportDraft(previewModel);
  }

  function openNewAbonentFromImport(row){
    // ‚úÖ –æ—Ç–º–µ—á–∞–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫—É —É–∂–µ —Ç—Ä–æ–≥–∞–ª–∏ –≤—Ä—É—á–Ω—É—é + —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ (–∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É)
    touchRow(row?.excelRow);

    const fio = splitFioParts(row?.fio);
    const q = new URLSearchParams();
    if (row?.ls) q.set('ls', String(row.ls));
    if (fio.last) q.set('last', fio.last);
    if (fio.first) q.set('first', fio.first);
    if (fio.mid) q.set('mid', fio.mid);
    if (row?.square !== '' && row?.square !== null && row?.square !== undefined) q.set('square', String(row.square));
    if (row?.uid) q.set('uid', String(row.uid));
    q.set('src', 'import_xls');
    // ‚úÖ —á—Ç–æ–±—ã new_abonent.html –∑–Ω–∞–ª, –∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è
    q.set('return', 'import_xls.html');
    window.location.href = 'new_abonent.html?' + q.toString();
  }

  function bindCreateButtons(model){
    document.querySelectorAll('button[data-create-ab="1"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const excelRow = Number(btn.getAttribute('data-excelrow'));
        const row = (model||[]).find(x => Number(x.excelRow) === excelRow);
        if (!row){ alert('–°—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.'); return; }
        openNewAbonentFromImport(row);
      });
    });
  }

  function recheckPreviewAgainstDB(){
    if (!previewModel || !Array.isArray(previewModel.rows)) return;

    for (const r of previewModel.rows){
      // ‚úÖ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º (–º–æ–∂–µ—Ç UID —É–∂–µ –ø–æ—è–≤–∏–ª—Å—è –≤ –±–∞–∑–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç–∞)
      recomputeRowAgainstDB(r);
    }

    // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å stats
    const stats = { ok:0, warn:0, err:0, neu:0, total: previewModel.rows.length };
    for (const r of previewModel.rows){
      if (r.status === 'error') stats.err++;
      else if (r.status === 'warn' || r.status === 'warn_new') stats.warn++;
      else if (r.status === 'ok') stats.ok++;
      else stats.neu++;
    }
    previewModel.stats = stats;

    renderPreview(previewModel.rows, stats);
    saveImportDraft(previewModel);
  }

  // ===== –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É =====
  (function restoreDraft(){
    const d = loadImportDraft();
    if (!d || !Array.isArray(d.rows) || !d.rows.length) return;

    previewModel = {
      fileName: d.fileName || '',
      rows: d.rows,
      stats: d.stats || null,
      touchedExcelRows: new Set(d.touchedExcelRows || [])
    };

    setFileStatus(previewModel.fileName ? ('–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ' + previewModel.fileName) : '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω (–∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)');
    renderPreview(previewModel.rows, previewModel.stats || {ok:0,warn:0,err:0,neu:0,total:previewModel.rows.length});

    // ‚úÖ –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ—Å–ª–µ new_abonent.html ‚Äî –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    const params = new URLSearchParams(location.search || '');
    if (params.get('recheck') === '1') {
      recheckPreviewAgainstDB();
    }
  })();

  btnPreview.addEventListener('click', () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file){
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel.');
      return;
    }

    if (!window.XLSX) {
      alert('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX.\n\n–ü–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª xlsx.full.min.js —Ä—è–¥–æ–º —Å import_xls.html (–≤ —Ç—É –∂–µ –ø–∞–ø–∫—É).');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      
      // =================== –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ===================
      // cellDates: false - –¥–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ —á–∏—Å–ª–∞ (Excel serial)
      const wb = XLSX.read(data, { 
        type: 'array', 
        cellDates: false,  // ‚Üê –ù–ï –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –≤ Date!
        cellNF: false,
        raw: true          // ‚Üê –æ—Å—Ç–∞–≤–ª—è—Ç—å raw –∑–Ω–∞—á–µ–Ω–∏—è
      });
      // =========================================================
      
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: '' });

      if (!rows || !rows.length){
        alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.');
        return;
      }

      const res = analyze(rows);

      previewModel = {
        rows: res.model,
        fileName: file.name,
        stats: res.stats,
        touchedExcelRows: new Set()
      };

      setFileStatus('–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª: ' + file.name);
      renderPreview(res.model, res.stats);
      saveImportDraft(previewModel);
    };
    reader.readAsArrayBuffer(file);
  });

  btnResetPreview.addEventListener('click', () => {
    if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä? –ß–µ—Ä–Ω–æ–≤–∏–∫ –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω.')) return;

    clearImportDraft();
    previewModel = null;

    previewContainer.innerHTML = '';
    summaryHint.textContent = '';
    btnConfirm.disabled = true;
    btnResetPreview.disabled = true;

    fileInput.value = '';
    setFileStatus('–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
  });

  btnConfirm.addEventListener('click', () => {
    if (!previewModel || !previewModel.rows){
      alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.');
      return;
    }

    const rows = previewModel.rows;

    let createdAb = 0;
    let assignedUid = 0;
    let addedDebts = 0;
    let addedPays = 0;
    let skipped = 0;

    // ‚úÖ Variant A: –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ —Å–¥–µ–ª–∞–µ–º –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –¥–ª—è –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –õ–°
    const affectedLs = new Set();

    for (const r of rows){
      if (r.status === 'error') { skipped++; continue; }

      const ls = String(r.ls || '');
      const uid = String(r.uid || '');
      if (!ls || !isValidUid(uid)) { skipped++; continue; }

      const existing = AbonentsDB.abonents?.[ls] || null;

      if (existing && existing.uid && String(existing.uid) !== uid){
        skipped++;
        continue;
      }

      if (!existing){
        AbonentsDB.abonents[ls] = {
          uid: uid,
          fio: r.fio || '',
          city: '',
          street: '',
          house: '',
          flat: '',
          square: (r.square === '' ? '' : Number(r.square)),
          rooms: '',
          share: '',
          calcDate: '',
          stateDate: '',
          docDate: '',
          debts: [],
          mainDebtTotal: 0,
          penaltyTotal: 0,
          totalDebt: 0,
          defaultNote: '',
          defaultExcludes: []
        };
        createdAb++;
      } else {
        if (!existing.uid){
          existing.uid = uid;
          assignedUid++;
        }
      }

      const a = AbonentsDB.abonents[ls];
      if (!Array.isArray(a.debts)) a.debts = [];

      for (const p of (r.payments || [])){
        if (debtsHasDuplicate(a.debts, p.dmy, p.amount)) continue;        const year = Number(String(p.iso||'').slice(0,4)) || new Date().getFullYear();
        const monthName = p.monthName;

        a.debts.push({
          year: year,
          month: monthName,
          accrued: 0,
          paid: r2(p.amount),
          payDate: p.dmy,
          paymentPeriod: `${monthName} ${year}`,
          penalty: 0,
          mainDebt: 0,
          debtPenalty: 0
        });
        addedDebts++;
      }

      const payArr = loadPayments(ls);
      let idCounter = nextPaymentId(payArr);

      for (const p of (r.payments || [])){
        if (paymentsHasDuplicate(payArr, p.iso, p.amount, p.source)) continue;        const iso = String(p.iso||'');
        const mm = iso.slice(5,7) || '01';
        const yy = iso.slice(0,4) || String(new Date().getFullYear());

        payArr.push({
          id: idCounter++,
          month: mm,
          year: yy,
          accrued: 0,
          paid: r2(p.amount),
          paid_date: p.iso,
          source: String(p.source || '').trim() || '–ü–ª–∞—Ç—ë–∂ 1',
          // üîí CRITICAL: –æ–ø–ª–∞—Ç–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ Excel –∏ –ù–ï –ø–æ–¥–ª–µ–∂–∏—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–ø–ª–∞—Ç
          import_locked: true,
          import_origin: 'excel_primary_v1',
          import_file: previewModel?.fileName || '',
          import_excel_row: Number(r.excelRow) || null,
          import_saved_at: new Date().toISOString(),
          use_period: false,
          // üî¥ CRITICAL: Excel-–∏–º–ø–æ—Ä—Ç –ù–ï –≤–∫–ª—é—á–∞–µ—Ç '–æ–ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥'.
          // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∞–±–æ–Ω–µ–Ω—Ç–∞.

          period_from_m: mm,
          period_from_y: yy,
          period_to_m: mm,
          period_to_y: yy,
          period_from: `${mm}.${yy}`,
          period_to: `${mm}.${yy}`,
          note: '',
          pay_main: 0,
          pay_penalty: 0,
          total_debt: 0
        });
        addedPays++;
      }

      savePayments(ls, payArr);

      // –æ—Ç–º–µ—Ç–∏–º –õ–° –∫–∞–∫ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–π –∏–º–ø–æ—Ä—Ç–æ–º (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–ª–∞—Ç –Ω–µ –±—ã–ª–æ ‚Äî –∞–±–æ–Ω–µ–Ω—Ç –º–æ–≥ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª—ë–Ω)
      affectedLs.add(ls);
    }

    try {
      if (typeof window.saveAbonentsDB === 'function') {
        window.saveAbonentsDB();
      } else {
        localStorage.setItem('abonents_db_v1', JSON.stringify(AbonentsDB));
      }
    } catch (e){
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å AbonentsDB', e);
    }

    // ‚úÖ –ê–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞, –±–µ–∑ UI)
    try {
      if (window.JKHAutoAccrual && typeof window.JKHAutoAccrual.recalcForMany === 'function') {
        const ids = Array.from(affectedLs);
        const res = window.JKHAutoAccrual.recalcForMany(ids);
        // –ª–æ–≥ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        const changed = res.filter(x => x && x.changed).length;
        if (changed) console.warn('[import] autoaccrual recalculated:', { affected: ids.length, changed });
      } else {
        console.warn('[import] JKHAutoAccrual –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω (autoaccrual_engine.js) ‚Äî –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏');
      }
    } catch (e){
      console.warn('[import] autoaccrual error', e);
    }

    alert(
      `–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.\n\n` +
      `–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö –∞–±–æ–Ω–µ–Ω—Ç–æ–≤: ${createdAb}\n` +
      `–ü—Ä–∏—Å–≤–æ–µ–Ω–æ UID —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º: ${assignedUid}\n` +
      `–î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–ª–∞—Ç –≤ debts[]: ${addedDebts}\n` +
      `–î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–ª–∞—Ç –≤ payments_<–õ–°>: ${addedPays}\n` +
      `–ü—Ä–æ–ø—É—â–µ–Ω–æ/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ —Å—Ç—Ä–æ–∫: ${skipped}`
    );

    // ‚úÖ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞ ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫ –¥–æ–ª–∂–µ–Ω –∏—Å—á–µ–∑–Ω—É—Ç—å
    clearImportDraft();

    // —Å–±—Ä–æ—Å UI
    btnConfirm.disabled = true;
    btnResetPreview.disabled = true;
    summaryHint.textContent = '';
    previewContainer.innerHTML = '';
    previewModel = null;
    fileInput.value = '';
    setFileStatus('–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
  });
});
</script>

</body>
</html>
[file content end]
