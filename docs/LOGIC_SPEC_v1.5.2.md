# –ü–ê–ü–ê–ñ–ö–• ‚Äî LOGIC_SPEC v1.5.2

–í–µ—Ä—Å–∏—è: **1.5.2**  
–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞—Ü–∏–∏: **2026-01-22**

–°—Ç–∞—Ç—É—Å: **–°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–Ø**  
–î–æ–∫—É–º–µ–Ω—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä–æ–µ–∫—Ç–∞.

---

## üîí –ö–û–ù–°–¢–ê–ù–¢–ê –ê–†–•–ò–í–ê (CRITICAL)

**–ê—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–∞, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–∫ —ç—Ç–∞–ª–æ–Ω –ª–æ–≥–∏–∫–∏:**

```
jkh_site_full_v01.21.5.zip
```

–î–∞–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤ —Å—á–∏—Ç–∞–µ—Ç—Å—è **–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π**.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –º–µ–Ω—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∞—Ä—Ö–∏–≤–∞ –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ LOGIC_SPEC;
- –≤–Ω–æ—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏ ¬´–ø–æ –º–µ—Å—Ç—É¬ª –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏.

–†–∞–∑—Ä–µ—à–µ–Ω–æ:
- —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ;
- –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–≤–µ—Ä—Ö (backward-compatible);
- —Ä–∞—Å—à–∏—Ä—è—Ç—å UI –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–Ω–æ–π –ª–æ–≥–∏–∫–∏.

---

## 0. –û–±–ª–∞—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è

–í—Å–µ –ø—Ä–∞–≤–∏–ª–∞ LOGIC_SPEC v1.4 **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–∏–ª—É**, –µ—Å–ª–∏ –Ω–∏–∂–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ.

LOGIC_SPEC v1.5:
- –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É,
- –∞ **—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞**.

---

## 1. –ù—É–ª–µ–≤–æ–π —Å—Ç–∞—Ä—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞ (CRITICAL)

–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—á—ë—Ç–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞ (`calcStartDate`, –ø–µ—Ä–∏–æ–¥ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏) ‚Äî –∂—ë—Å—Ç–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞.

–î–æ —ç—Ç–æ–π –¥–∞—Ç—ã:
- –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç;
- –æ–ø–ª–∞—Ç—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç;
- –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å = 0;
- –ø–µ–Ω—è = 0.

–§–æ—Ä–º–∞–ª—å–Ω–æ:

```
–µ—Å–ª–∏ monthStart < calcStartDate
‚Üí pay_main = 0
‚Üí pay_penalty = 0
‚Üí total_debt = 0
```

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- `payment_table.js` ‚Äî –æ—Ç—Å–µ—á–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–æ —Ä–∞—Å—á—ë—Ç–∞ –∏—Ç–æ–≥–æ–≤;
- `new_abonent.html` ‚Äî –Ω–æ–≤—ã–π –∞–±–æ–Ω–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å —á–∏—Å—Ç–æ–≥–æ –Ω—É–ª—è;
- –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è.

---

## 2. –ò–º–ø–æ—Ä—Ç Excel (CRITICAL)

### 2.1 –®–∞–±–ª–æ–Ω—ã

- `–®–∞–±–ª–æ–Ω–ù–æ–≤—ã–µ–ø–µ—Ä–≤–∏—á–Ω—ã–µ–¥–∞–Ω–Ω—ã–µ.xlsx` ‚Äî —Ä–∞–±–æ—á–∏–π —Ñ–∞–π–ª;
- `–®–∞–±–ª–æ–Ω–ù–æ–≤—ã–µ–ø–µ—Ä–≤–∏—á–Ω—ã–µ–¥–∞–Ω–Ω—ã–µ02.xlsx` ‚Äî –ø–æ—è—Å–Ω—è—é—â–∏–π —Ñ–∞–π–ª (–æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏).

### 2.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø–ª–∞—Ç

- —Å—Ç—Ä–æ–∫–∞: **15**;
- 72 —Å—Ç–æ–ª–±—Ü–∞ (6 √ó 12 –º–µ—Å—è—Ü–µ–≤);
- –≤ –∫–∞–∂–¥–æ–º –º–µ—Å—è—Ü–µ:
  - –ü–ª–∞—Ç—ë–∂ 1 ‚Üí –º–∞—Ä–∫–µ—Ä `444`;
  - –ü–ª–∞—Ç—ë–∂ 2 ‚Üí –º–∞—Ä–∫–µ—Ä `555`;
  - –ü–ª–∞—Ç—ë–∂ 3 ‚Üí –º–∞—Ä–∫–µ—Ä `666`.

### 2.3 –ü—Ä–∞–≤–∏–ª–∞ –∏–º–ø–æ—Ä—Ç–∞

–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ:
- –∫–∞–∂–¥–∞—è –Ω–∞–π–¥–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É;
- –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–ü–ª–∞—Ç—ë–∂ 1/2/3);
- `use_period = false`;
- `period_from / period_to = null`;
- –¥–∞—Ç–∞ –∏ —Å—É–º–º–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ –≤ Excel.

### 2.4 –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–Ω—ã—Ö –æ–ø–ª–∞—Ç (CRITICAL)

–í—Å–µ –æ–ø–ª–∞—Ç—ã –∏–∑ Excel:
- –ø–æ–º–µ—á–∞—é—Ç—Å—è `import_locked = true`;
- –Ω–µ –ø–æ–¥–ª–µ–∂–∞—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:
  - —Å—É–º–º–∞,
  - –¥–∞—Ç–∞,
  - –∏—Å—Ç–æ—á–Ω–∏–∫,
  - —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏.

–í UI –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∑–Ω–∞—á–∫–æ–º:

```
üì• –ò–º–ø–æ—Ä—Ç (Excel)
```

---

## 3. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–ø–ª–∞—Ç

- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–µ–¥—É—Ç—Å—è —á–µ—Ä–µ–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫;
- –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è;
- —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–º–µ–Ω—É;
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ.

---

## 4. –û–ø–ª–∞—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (CRITICAL)

### 4.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ** –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø–µ–Ω–∏.

### 4.2 –ê–∫—Ç–∏–≤–∞—Ü–∏—è

- –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º;
- –∏–º–ø–æ—Ä—Ç Excel –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å `use_period`.

### 4.3 –ü–æ–≤–µ–¥–µ–Ω–∏–µ

–ü—Ä–∏ `use_period = true`:
- –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–ª–≥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è;
- –ø–µ–Ω—è —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤ –ø–µ—Ä–∏–æ–¥–µ;
- –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã –æ—Å—Ç–∞—ë—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π.


### 4.4 payments_<LS> ‚Äî –µ–¥–∏–Ω—ã–π –ø–æ–º–µ—Å—è—á–Ω—ã–π ledger (CRITICAL)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.** `payments_<LS>` (–ø—Ä–∏–º–µ—Ä: `payments_0001`) ‚Äî —ç—Ç–æ **–µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫**, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø—Ä—è–º—É—é —Ä–∏—Å—É–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ ¬´–û–ø–ª–∞—Ç–∞ –∞–±–æ–Ω–µ–Ω—Ç–∞¬ª –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö.

–ö–ª—é—á–µ–≤–æ–µ: —ç—Ç–æ **–Ω–µ –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –ø–ª–∞—Ç–µ–∂–µ–π**, –∞ **ledger-—Ç–∞–±–ª–∏—Ü–∞ –ø–æ –º–µ—Å—è—Ü–∞–º**. –í –æ–¥–Ω–æ–º –º–µ—Å—è—Ü–µ –¥–æ–ø—É—Å—Ç–∏–º–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ (–∏–º–ø–æ—Ä—Ç + –æ–¥–Ω–∞/–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä—É—á–Ω—ã—Ö –æ–ø–ª–∞—Ç).

#### 4.4.1 –î–≤–∞ –ø—É—Ç–∏ –æ–ø–ª–∞—Ç—ã = –¥–≤–∞ —Ç–∏–ø–∞ —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º –∫–ª—é—á–µ

1) **–ò–º–ø–æ—Ä—Ç –∏–∑ Excel** —Å–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/–∏–º–ø–æ—Ä—Ç–∞ (—á–∞—Å—Ç–æ —Å —Ñ–ª–∞–≥–∞–º–∏ `is_imported=true` –∏/–∏–ª–∏ `import_locked=true`/`locked=true`). –¢–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ **–Ω–µ–ª—å–∑—è** —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.

2) **–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ UI ¬´–î–æ–±–∞–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª** —Å–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä–æ–∫–∏ —Ä—É—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã (manual) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ —Ç–æ—Ç –∂–µ `payments_<LS>`.

–°–ª–µ–¥—Å—Ç–≤–∏–µ: –≤ —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ ‚Äî —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

#### 4.4.2 Data Contract (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ JSON-–ø—Ä–∏–º–µ—Ä—ã —Å—Ç—Ä–æ–∫)

**A) –°—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/–∏–º–ø–æ—Ä—Ç–∞ (immutable / locked):**
```json
{
  "id": 13,
  "year": "2026",
  "month": "01",
  "accrued": 200.00,
  "paid": 0.00,
  "paid_date": "",
  "source": "–ü–ª–∞—Ç—ë–∂ 1",
  "is_imported": true,
  "import_locked": true,
  "locked": true,
  "use_period": false,
  "pay_for_period": "",
  "created_at": "2026-01-22T08:33:32.160Z"
}
```

**B) –°—Ç—Ä–æ–∫–∞ —Ä—É—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã (manual):**
```json
{
  "id": 21,
  "year": "2026",
  "month": "01",
  "accrued": 0.00,
  "paid": 123.45,
  "paid_date": "2026-01-22",
  "payment_date": "2026-01-22",
  "source": "–ü–ª–∞—Ç—ë–∂ 1",
  "is_imported": false,
  "locked": false,
  "use_period": false,
  "pay_for_period": "",
  "note": ""
}
```

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–∞—Ç—ã (`paid_date` –∏/–∏–ª–∏ `payment_date`) ‚Äî —Ä–∞—Å—á—ë—Ç –æ–±—è–∑–∞–Ω –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å;
- `use_period` / `pay_for_period` ‚Äî **–º–µ—Ç–∫–∞**, –Ω–µ –º–µ–Ω—è–µ—Ç —Ñ–∞–∫—Ç –¥–∞—Ç—ã –æ–ø–ª–∞—Ç—ã –∏ –Ω–µ ‚Äú–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç‚Äù –ø—Ä–æ—Å—Ä–æ—á–∫—É –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º.

#### 4.4.3 CRITICAL: anti-retro (–∑–∞–ø—Ä–µ—Ç —Ä–µ—Ç—Ä–æ‚Äë–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏)

‚Äú–û–ø–ª–∞—Ç–∞ –∑–∞ –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥‚Äù **–Ω–µ –¥–æ–ª–∂–Ω–∞**:
- –º–µ–Ω—è—Ç—å –¥–∞—Ç—É —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –æ–ø–ª–∞—Ç—ã;
- –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø–µ–Ω–∏ —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ –¥–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø–∏–ª–∏ —Ä–∞–Ω—å—à–µ;
- –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –ø—Ä–æ—à–ª—ã–µ –º–µ—Å—è—Ü—ã ‚Äú–∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º‚Äù.

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–∞—Ç–∞, –≤–ª–∏—è—é—â–∞—è –Ω–∞ –ø–µ–Ω—é, ‚Äî **–¥–∞—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è** (`paid_date`/`payment_date`).

#### 4.4.4 –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü—É (–∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å –¥–æ–ª–≥ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö –º–µ—Å—è—Ü–∞)

–î–ª—è –º–µ—Å—è—Ü–∞ `YM = YYYY-MM`:
- `accruedYM` = **max(accrued)** –ø–æ —Å—Ç—Ä–æ–∫–∞–º –º–µ—Å—è—Ü–∞ (–≤ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ ‚Äú–æ–¥–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –º–µ—Å—è—Ü‚Äù);
- `paidYM` = **sum(paid)** –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º –º–µ—Å—è—Ü–∞ (manual + –∏–º–ø–æ—Ä—Ç–Ω—ã–µ, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –µ—Å—Ç—å);
- `debtYM = max(0, accruedYM - paidYM)`.

#### 4.4.5 –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ ledger ‚Üí –ø–æ–º–µ—Å—è—á–Ω—ã–µ –∏—Ç–æ–≥–∏
```pseudo
function normalizeDate(row):
    return row.paid_date || row.payment_date || ""

function ymKey(row):
    y = String(row.year)
    m = pad2(String(row.month))
    return y + "-" + m

function buildMonthlyIndex(rows):
    idx = map YM -> {accrued:0, paid:0, paidDates:[]}

    for row in rows:
        YM = ymKey(row)
        if not idx[YM]: idx[YM] = {accrued:0, paid:0, paidDates:[]}

        a = toNumber(row.accrued)
        p = toNumber(row.paid)

        // "–æ–¥–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –º–µ—Å—è—Ü" ‚Üí –±–µ—Ä—ë–º max accrued –ø–æ –º–µ—Å—è—Ü—É
        if a > idx[YM].accrued:
            idx[YM].accrued = a

        idx[YM].paid += p

        d = normalizeDate(row)
        if p > 0 and d != "":
            idx[YM].paidDates.push(d)

    for YM in idx:
        idx[YM].debt = max(0, idx[YM].accrued - idx[YM].paid)
        idx[YM].lastPaidDate = maxDate(idx[YM].paidDates) // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí ""

    return idx
```---

## 4.5 –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞—Å—á—ë—Ç–µ –ø–µ–Ω–∏ (CRITICAL)

**ID:** `CRITICAL-REFINANCE-CAP-9_5`

### 4.5.1 –ü—Ä–∞–≤–∏–ª–æ
–ü—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –ø–µ–Ω–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–≤–∫–∏ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è:

- **–¥–æ 01.01.2027** —Å—Ç–∞–≤–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤ —Ñ–æ—Ä–º—É–ª–µ –ø–µ–Ω–∏, **–Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 9,5% –≥–æ–¥–æ–≤—ã—Ö**;
- –Ω–∞—á–∏–Ω–∞—è —Å **01.01.2027** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–≤–∫–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.

–§–æ—Ä–º–∞–ª—å–Ω–æ:
```
effective_rate = min(raw_rate, 9.5)   // –µ—Å–ª–∏ date < 2027-01-01
effective_rate = raw_rate             // –µ—Å–ª–∏ date >= 2027-01-01
```

### 4.5.2 –í–∞–∂–Ω–æ
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –≤ —Ä–∞—Å—á—ë—Ç–µ**, –∞ –Ω–µ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ —Å—Ç–∞–≤–æ–∫.
- –í localStorage —Å—Ç–∞–≤–∫–∏ –º–æ–≥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ª—é–±—ã–µ (–≤ —Ä–∞–º–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ 0..100), –Ω–æ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –ø–µ–Ω–∏ –±–µ—Ä—ë—Ç—Å—è `effective_rate`.
- –ü—Ä–∞–≤–∏–ª–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç:
  - –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –≤–∑—ã—Å–∫–∞–Ω–∏—è,
  - –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –æ–ø–ª–∞—Ç,
  - –Ω–∞–ª–∏—á–∏—è/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä—É—á–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫.

### 4.5.3 –ì–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- `payment_table.js` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä `capRateUntil2027(dateObj, rate)`), –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—Ç–∞–≤–∫–∏ –≤ –¥–Ω–µ–≤–Ω–æ–º —Ä–∞—Å—á—ë—Ç–µ –ø–µ–Ω–∏.

### 4.5.4 –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ UI (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ)
–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ **¬´–°—Ç–∞–≤–∫–∞ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è¬ª** –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
> ¬´–î–æ 01.01.2027 –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –ø–µ–Ω–∏ —Å—Ç–∞–≤–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è 9,5% –≥–æ–¥–æ–≤—ã—Ö¬ª.

–£–¥–∞–ª–µ–Ω–∏–µ/–æ–±—Ö–æ–¥ —ç—Ç–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∏**.



---

## 5. –†–∞—Å—á—ë—Ç –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∞–≤–∞–Ω—Å–∞

- –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–º –∏—Ç–æ–≥–æ–º;
- –µ—Å–ª–∏ –æ–ø–ª–∞—Ç—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ‚Üí –æ–±—Ä–∞–∑—É–µ—Ç—Å—è –∞–≤–∞–Ω—Å;
- –∞–≤–∞–Ω—Å:
  - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ –∑–Ω–∞–∫–æ–º –º–∏–Ω—É—Å;
  - –≤—ã–¥–µ–ª—è–µ—Ç—Å—è —Ç—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º;
  - —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º —Ä–∞—Å—á—ë—Ç–µ.

---

## 6. –†–∞—Å—á—ë—Ç –≤–∑—ã—Å–∫–∏–≤–∞–µ–º–æ–π —Å—É–º–º—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ (CRITICAL)

### 6.1 –ü—Ä–∞–≤–∏–ª–æ

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–µ—Ä–∏–æ–¥–∞ –≤–∑—ã—Å–∫–∞–Ω–∏—è:

- —Ä–∞—Å—á—ë—Ç —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å –Ω—É–ª—è –Ω–∞ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–∏–æ–¥–∞;
- –¥–æ–ª–≥ –¥–æ –ø–µ—Ä–∏–æ–¥–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è;
- —Å—á–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ –ø–µ—Ä–∏–æ–¥–∞.

–§–æ—Ä–º–∞–ª—å–Ω–æ:

```
debt_at_period_start = 0
debt = Œ£(–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞) ‚àí Œ£(–æ–ø–ª–∞—Ç—ã –ø–µ—Ä–∏–æ–¥–∞)
```

---

## 7. –¢–∞—Ä–∏—Ñ—ã: —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ —Ä–µ–º–æ–Ω—Ç

### 7.1 –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç–∞—Ä–∏—Ñ–∞

- –¥–∞—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ **–Ω–∞—á–∞–ª–æ–º –º–µ—Å—è—Ü–∞**;
- –≤—ã–±–æ—Ä –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º `–º–µ—Å—è—Ü/–≥–æ–¥`;
- –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `YYYY-MM-01`.

### 7.2 –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –æ–¥–∏–Ω —Ç–∞—Ä–∏—Ñ –Ω–∞ –æ–¥–∏–Ω –º–µ—Å—è—Ü;
- –¥—É–±–ª–∏–∫–∞—Ç—ã –º–µ—Å—è—Ü–µ–≤ –∑–∞–ø—Ä–µ—â–µ–Ω—ã;
- –¥–∞—Ç—ã —Å–µ—Ä–µ–¥–∏–Ω—ã –º–µ—Å—è—Ü–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è.

### 7.3 –ü–æ–≤–µ–¥–µ–Ω–∏–µ

- –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π.

---

## 8. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞

- –∫–ª—é—á–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `constants.js`;
- –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–º–µ—é—Ç fallback-–∑–∞—â–∏—Ç—É;
- –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø–∞–¥–µ–Ω–∏—é UI.

---

## 9. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –º–∏–≥—Ä–∏—Ä—É—é—Ç—Å—è;
- –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏;
- –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä—ë–¥.

---

## 10. –ü—Ä–∏—ë–º–∫–∞

–ü—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º, –µ—Å–ª–∏:
- LOGIC_CHECKLIST v1.4 –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫;
- –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–æ–ª–≥–∏;
- –∏–º–ø–æ—Ä—Ç–Ω—ã–µ –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è;
- —Ä–∞—Å—á—ë—Ç –ø–µ—Ä–∏–æ–¥–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å –Ω—É–ª—è;
- —Ç–∞—Ä–∏—Ñ—ã –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç —Å–µ—Ä–µ–¥–∏–Ω—É –º–µ—Å—è—Ü–∞;
- –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –ø–µ–Ω–∏ –¥–æ 01.01.2027 –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ 9,5%.

---

**LOGIC_CHECKLIST v1.4 ‚Äî –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô.**